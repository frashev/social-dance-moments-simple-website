<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workshop Map - SDM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        nav { background: #667eea; color: white; padding: 15px; text-align: center; }
        nav h1 { font-size: 18px; margin-bottom: 10px; }
        nav button { background: #e74c3c; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px; transition: 0.3s; font-size: 14px; }
        nav button:hover { background: #c0392b; transform: scale(1.05); }
        .container { display: grid; grid-template-columns: 1fr 600px; gap: 20px; max-width: 1400px; margin: 0 auto; padding: 20px; height: calc(100vh - 100px); }
        #map { height: 100%; border-radius: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); filter: brightness(1.0); position: sticky; top: 20px; z-index: 10; }
        .sidebar { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); max-height: 100%; overflow-y: auto; z-index: 5; position: relative; }
        .sidebar::-webkit-scrollbar { width: 8px; }
        .sidebar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .sidebar::-webkit-scrollbar-thumb { background: #667eea; border-radius: 10px; }
        .sidebar::-webkit-scrollbar-thumb:hover { background: #764ba2; }
        .sidebar h3 { color: #667eea; margin-bottom: 15px; }
        .workshop-item { padding: 15px; margin-bottom: 10px; background: #f9f9f9; border-left: 4px solid #667eea; border-radius: 5px; cursor: pointer; transition: all 0.3s; }
        .workshop-item:hover { background: #e8e8ff; transform: translateX(5px); }
        .workshop-item strong { color: #667eea; }
        .workshop-item small { color: #666; display: block; margin-top: 5px; }
        .workshop-description {
            color: #555;
            display: -webkit-box;
            -webkit-line-clamp: 5;
            line-clamp: 5;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .workshop-location {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 6px;
            color: #667eea;
            font-weight: 800;
            letter-spacing: 0.3px;
            background: linear-gradient(120deg, #10fc2b, #fedd1d, #fde68a, #04ff58);
            background-size: 240% 240%;
            text-shadow: 0 0 6px rgba(255, 255, 255, 0.95), 0 0 14px rgba(251, 191, 36, 0.85);
            box-shadow: 0 0 12px rgba(14, 165, 233, 0.35), 0 0 18px rgba(251, 191, 36, 0.35), inset 0 0 6px rgba(255, 255, 255, 0.5);
            animation: locationShimmer 5s ease-in-out infinite;
        }

        .workshop-datetime {
            display: inline-block;
            padding: 2px 7px;
            border-radius: 6px;
            font-weight: 700;
            color: #000000;
            background: #ffffff;
            background-size: 200% 200%;
            box-shadow: 0 0 10px rgba(249, 115, 22, 0.25), inset 0 0 6px rgba(255, 255, 255, 0.6);
            text-shadow: 0 0 6px rgba(255, 255, 255, 0.7);
            animation: dateGlow 6s ease-in-out infinite;
        }

        .workshop-instructor {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 6px;
            font-weight: 800;
            color: #1f2937;
            background: linear-gradient(120deg, #fde68a, #fbbf24, #f59e0b);
            background-size: 200% 200%;
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.25), inset 0 0 4px rgba(255, 255, 255, 0.7);
            text-shadow: 0 0 6px rgba(255, 255, 255, 0.7);
            animation: dateGlow 6s ease-in-out infinite;
        }

        @keyframes dateGlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes locationShimmer {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .filter-box { margin-bottom: 20px; }
        .filter-box input, .filter-box select { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px; transition: 0.3s; }
        .filter-box input:focus, .filter-box select:focus { border-color: #667eea; box-shadow: 0 0 5px rgba(102, 126, 234, 0.2); outline: none; }
        .filter-box button { width: 100%; padding: 10px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; transition: 0.3s; }
        .filter-box button:hover { background: #764ba2; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }

        /* Workshop/Party Filter Button Styling */
        .style-filter-group { display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
        .style-filter-group button { flex: 1; min-width: 70px; padding: 8px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px; transition: all 0.3s ease; }
        .style-filter-group button:hover { transform: translateY(-2px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); }
        .style-filter-group button.active { background: #2ecc71; font-weight: bold; box-shadow: 0 4px 12px rgba(46, 204, 113, 0.4); }

        /* Date filter button styling */
        .date-filter-group { display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
        .date-filter-group button { flex: 1; min-width: 70px; padding: 8px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px; transition: all 0.3s ease; }
        .date-filter-group button:hover { transform: translateY(-2px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); }
        .date-filter-group button.active { background: #2ecc71; font-weight: bold; box-shadow: 0 4px 12px rgba(46, 204, 113, 0.4); }

        /* Hide Leaflet default controls */
        .leaflet-control-zoom,
        .leaflet-bar,
        .leaflet-control {
            display: none !important;
        }

        /* Leaflet popup styling */
        .leaflet-popup-content-wrapper {
            max-width: 300px !important;
            width: 300px !important;
            padding: 0 !important;
        }

        .leaflet-popup-content {
            width: 100% !important;
            max-width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow: hidden !important;
            overflow-wrap: break-word !important;
            word-wrap: break-word !important;
            word-break: break-word !important;
        }

        .leaflet-popup-content * {
            max-width: 100% !important;
            box-sizing: border-box !important;
            overflow: hidden !important;
            overflow-wrap: break-word !important;
            word-wrap: break-word !important;
            word-break: break-word !important;
        }

        @media (max-width: 768px) {
            .leaflet-popup-content-wrapper {
                max-width: 200px !important;
                width: 200px !important;
            }

            .leaflet-popup-content {
                width: 100% !important;
            }
        }

        @media (max-width: 480px) {
            .leaflet-popup-content-wrapper {
                max-width: 200px !important;
                width: 200px !important;
            }

            .leaflet-popup-content {
                width: 100% !important;
            }
        }

        /* Layer selector */
        .layer-selector { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); margin-bottom: 15px; }
        .layer-selector select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; cursor: pointer; }
        .layer-selector label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: #333; }

        /* Toast notifications */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast { background: white; padding: 14px 20px; margin-bottom: 10px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); animation: slideIn 0.3s ease-out; min-width: 280px; border-left: 3px solid #999; font-size: 13px; }
        .toast.success { border-left-color: #666; background: #f0f0f0; color: #333; }
        .toast.error { border-left-color: #666; background: #f0f0f0; color: #333; }
        .toast.warning { border-left-color: #999; background: #f8f8f8; color: #555; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { to { transform: translateX(400px); opacity: 0; } }
        .toast.removing { animation: slideOut 0.3s ease-in forwards; }

        /* Scroll to top button */
        #scrollToTopBtn {
            display: none;
            position: fixed;
            bottom: 30px;
            right: 20px;
            z-index: 99;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }

        #scrollToTopBtn:hover {
            background: #764ba2;
            transform: translateY(-5px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
        }

        #scrollToTopBtn.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 768px) {
            #scrollToTopBtn {
                bottom: 20px;
                right: 15px;
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
        }

        @media (max-width: 480px) {
            #scrollToTopBtn {
                bottom: 15px;
                right: 10px;
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            nav { padding: 10px; }
            nav h1 { font-size: 16px; margin-bottom: 8px; }
            nav button { padding: 8px 12px; margin-left: 5px; font-size: 12px; }

            .container {
                grid-template-columns: 1fr;
                gap: 10px;
                padding: 10px;
                height: calc(100vh - 20px);
            }

            #map {
                height: 400px;
                border-radius: 8px;
                position: sticky;
                top: 10px;
            }

            .sidebar {
                max-height: 60vh;
                padding: 15px;
            }

            .filter-box {
                background: white;
                padding: 15px;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            #cityFilter {
                font-size: 16px !important;
                padding: 12px !important;
                margin: 10px 0 !important;
                width: 100%;
                border: 2px solid #667eea;
                border-radius: 5px;
            }

            .filter-box input,
            .filter-box select {
                font-size: 14px;
                padding: 8px;
            }

            .workshop-item {
                padding: 12px;
                margin-bottom: 8px;
            }

            .workshop-item small {
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            nav { padding: 8px; }
            nav h1 { font-size: 14px; margin-bottom: 5px; }
            nav button { padding: 6px 10px; margin-left: 3px; font-size: 12px; }

            .container {
                padding: 8px;
                gap: 5px;
                grid-template-columns: 1fr;
                height: auto;
            }

            #map {
                height: 320px;
                position: sticky;
                top: 8px;
            }

            .sidebar {
                max-height: none;
                padding: 12px;
            }

            .filter-box {
                background: white;
                padding: 12px;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            #cityFilter {
                font-size: 12px !important;
                padding: 10px !important;
                margin: 8px 0 !important;
                width: 100%;
                border: 2px solid #667eea;
                border-radius: 5px;
            }

            .filter-box h4,
            .filter-box h5 {
                font-size: 13px;
                margin-bottom: 5px;
            }

            .filter-box input,
            .filter-box select {
                font-size: 12px;
                padding: 6px;
                margin: 3px 0;
            }

            .workshop-item {
                padding: 10px;
                margin-bottom: 6px;
                border-left-width: 3px;
            }

            .workshop-item small {
                font-size: 12px;
                line-height: 1.4;
            }

            .legend {
                padding: 10px;
                margin-bottom: 15px;
            }

            .legend h4 {
                font-size: 12px;
                margin-bottom: 8px;
            }

            .legend-item {
                margin-bottom: 5px;
                font-size: 12px;
            }

            .layer-selector {
                padding: 8px;
                margin-bottom: 10px;
            }

            .layer-selector label {
                font-size: 12px;
                margin-bottom: 4px;
            }

            .layer-selector select {
                padding: 6px;
                font-size: 12px;
            }

            .toast {
                min-width: 200px;
                padding: 10px 14px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <nav>
        <h1>üó∫Ô∏è Social Dance Workshops & Parties Map</h1>
        <button onclick="goHome()" style="background: #27ae60;">Home</button>
        <button onclick="window.location.href='/events.html'" style="background: #27ae60;">Festivals & Events Map</button>
        <button id="logoutBtn" onclick="logout()" style="display: none;">Logout</button>
        <button id="loginBtn" onclick="window.location.href='/login.html'" style="display: none; background: #3498db;">Login</button>
    </nav>
    <div class="container">
        <div id="map"></div>
        <div class="sidebar">
            <div style="background: #e8f4f8; padding: 12px; border-radius: 5px; margin-bottom: 15px; border-left: 4px solid #2980b9;">
                <p style="color: #2980b9; font-weight: bold; margin: 0; font-size: 13px;">üìÖ Dates</p>
                <p id="weekDisplayRange" style="color: #555; font-size: 12px; margin: 5px 0 0 0;">Loading...</p>
            </div>

            <div class="filter-box">
                <h4 style="margin-bottom: 10px;">üîç Filter</h4>
                <select id="styleFilter" onchange="filterWorkshops()" style="width: 100%; padding: 8px; background: #2ecc71; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-bottom: 10px;">
                    <option value="">All Styles</option>
                    <option value="salsa">Salsa</option>
                    <option value="bachata">Bachata</option>
                    <option value="kizomba">Kizomba</option>
                    <option value="zouk">Zouk</option>
                    <option value="lets_party">Let's Party</option>
                </select>
                <input type="text" id="cityFilter" placeholder="Search by city..." value="sofia" style="margin-bottom: 10px;">
                <button onclick="searchCity()" style="width: 100%; padding: 8px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px; margin-bottom: 10px;">Search City</button>

                <!-- Workshop/Party Filter -->
                <h5 style="margin-top: 10px; margin-bottom: 8px; color: #667eea;">üé™ Filter by Type</h5>
                <div class="style-filter-group">
                    <button class="active" id="filterAll" onclick="filterByType('all')">All</button>
                    <button id="filterWorkshops" onclick="filterByType('workshops')">Workshops</button>
                    <button id="filterParties" onclick="filterByType('parties')">Parties</button>
                </div>

                <!-- Date Filter Section -->
                <h5 style="margin-top: 15px; margin-bottom: 8px; color: #667eea; display: flex; align-items: center; gap: 8px;">
                    üìÖ Date Filter
                    <span id="dateFilterRange" style="font-size: 13px; font-weight: 500; color: #3498db; padding: 2px 8px; border-radius: 12px; white-space: nowrap;"></span>
                </h5>
                <div class="date-filter-group">
                    <button class="active" id="dateCurrentWeek" onclick="filterByCurrentWeek()">This Week</button>
                    <button id="datePrevWeek" onclick="filterByPreviousWeek()">Previous Week</button>
                    <button id="dateNextWeek" onclick="filterByNextWeek()">Next Week</button>
                    <button id="dateToday" onclick="filterByToday()">Today</button>
                    <button id="dateSpecific" onclick="toggleSpecificDateMode()">Date</button>
                </div>

                <!-- Date Range Inputs (hidden by default) -->
                <div id="dateRangeInputs" style="display: none; margin-bottom: 10px;">
                    <label style="font-size: 12px; color: #555;">From:</label>
                    <input type="date" id="dateFrom" style="margin-bottom: 5px;">
                    <label style="font-size: 12px; color: #555;">To:</label>
                    <input type="date" id="dateTo" style="margin-bottom: 5px;">
                    <button onclick="filterByDateRange()" style="width: 100%; padding: 8px; background: #2980b9; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">Apply Range</button>
                </div>

                <!-- Specific Date Input (hidden by default) -->
                <div id="specificDateInput" style="display: none; margin-bottom: 10px;">
                    <label style="font-size: 12px; color: #555;">Select Date:</label>
                    <input type="date" id="specificDate" style="margin-bottom: 5px;">
                    <button onclick="filterBySpecificDate()" style="width: 100%; padding: 8px; background: #8e44ad; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">Apply Date</button>
                </div>
            </div>

            <div class="layer-selector">
                <label for="layerSelect">üó∫Ô∏è Map Layer</label>
                <select id="layerSelect" onchange="changeLayer(this.value)">
                    <option value="osm">Standard (OSM)</option>
                    <option value="satellite">Satellite (Esri)</option>
                    <option value="cartodb-light">CartoDB Light</option>
                    <option value="cartodb-voyager" selected>CartoDB Voyager</option>
                </select>
            </div>

            <h3>üìç Workshops & Parties</h3>
            <div id="workshopList">
                <p>Loading workshops & parties...</p>
            </div>
        </div>
    </div>

    <button id="scrollToTopBtn" onclick="scrollToTop()" title="Back to top">‚¨ÜÔ∏è</button>

    <script>
        // Get auth token if available (optional for public map view)
        let token = sessionStorage.getItem('access_token');
        const userId = sessionStorage.getItem('user_id');

        // Refresh token automatically
        async function refreshTokenIfNeeded() {
            if (!token) return;

            try {
                const formData = new FormData();
                formData.append('token', token);

                const res = await fetch('/refresh', { method: 'POST', body: formData });
                if (res.ok) {
                    const data = await res.json();
                    if (data.access_token) {
                        token = data.access_token;
                        sessionStorage.setItem('access_token', token);
                        console.log('‚úÖ Token refreshed');
                    }
                }
            } catch (err) {
                console.error('Token refresh failed:', err);
            }
        }

        // Check token every 5 minutes
        setInterval(refreshTokenIfNeeded, 5 * 60 * 1000);

        // Map is publicly accessible - no auth required
        // Show appropriate nav button based on auth status
        if (token && userId) {
            document.getElementById('logoutBtn').style.display = 'inline-block';
        } else {
            document.getElementById('loginBtn').style.display = 'inline-block';
        }

        // Navigate to Home with auth check - prevents flashing home.html if not logged in
        function goHome() {
            if (token && userId) {
                window.location.href = '/home.html';
            } else {
                window.location.href = '/login.html';
            }
        }

        // Initialize map centered on Europe (dance capital!)
        const map = L.map('map').setView([42.6977, 23.3219], 12); // Sofia

        // Store current layer reference
        let currentLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '¬© CartoDB, ¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // Layer configurations
        const layers = {
            'osm': {
                url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                attribution: '¬© OpenStreetMap contributors'
            },
            'satellite': {
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                attribution: '¬© Esri'
            },
            'cartodb-light': {
                url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                attribution: '¬© CartoDB, ¬© OpenStreetMap contributors'
            },
            'cartodb-voyager': {
                url: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
                attribution: '¬© CartoDB, ¬© OpenStreetMap contributors'
            }
        };

        function changeLayer(layerName) {
            const layerConfig = layers[layerName];
            if (!layerConfig) return;

            // Remove current layer
            map.removeLayer(currentLayer);

            // Add new layer
            currentLayer = L.tileLayer(layerConfig.url, {
                attribution: layerConfig.attribution,
                maxZoom: 19
            }).addTo(map);
        }

        let allWorkshops = [];
        let markers = [];
        let styleTypeFilter = 'all'; // 'all', 'workshops', or 'parties'
        let activeDateFilter = {
            type: 'week', // 'week', 'today', 'range', 'date', or null
            data: null // stores range dates, specific date, etc.
        };

        const styleColors = {
            'salsa': '#c0392b',
            'bachata': '#2980b9',
            'kizomba': '#27ae60',
            'zouk': '#8e44ad',
            'lets_party': '#e74c3c'
        };

        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${months[date.getMonth()]} ${date.getDate()} ${date.getFullYear()}`;
        }

        function getFullWeekdayName(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return weekdays[date.getDay()];
        }

        function formatDateWithWeekday(dateStr) {
            const weekday = getFullWeekdayName(dateStr);
            const formattedDate = formatDate(dateStr);
            return `${weekday}, ${formattedDate}`;
        }

        function getWeekDateRangeWithOffset(weekOffset = 0) {
            const today = new Date();
            const currentDay = today.getDay();

            // Calculate Monday of current week (0 = Sunday, so Monday = 1)
            const daysFromMonday = currentDay === 0 ? 6 : currentDay - 1;
            const monday = new Date(today);
            monday.setDate(today.getDate() - daysFromMonday);

            // Move to target week (0 = current week, 1 = next week, 2 = week after next, ...)
            monday.setDate(monday.getDate() + (weekOffset * 7));

            // Calculate Sunday of current week
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);

            // Format as YYYY-MM-DD
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            return {
                start: formatDate(monday),
                end: formatDate(sunday)
            };
        }

        function getWeekDateRange() {
            return getWeekDateRangeWithOffset(0);
        }

        function getNextWeekDateRange(weekOffset = 1) {
            return getWeekDateRangeWithOffset(weekOffset);
        }

        // NOTE: We intentionally do NOT allow navigating to past weeks.
        // The "Previous Week" button acts as a back button from future weeks toward the current week.

        async function loadWorkshops() {
            try {
                const res = await fetch('/workshops');
                const data = await res.json();
                allWorkshops = data.workshops;

                // Expand weekly events to show all future occurrences
                allWorkshops = expandWeeklyEvents(allWorkshops);

                // Filter to show only current week by default
                const weekRange = getWeekDateRange();
                activeDateFilter = { type: 'week', data: null };
                const currentWeekWorkshops = allWorkshops.filter(w =>
                    w.date >= weekRange.start && w.date <= weekRange.end
                );

                // Update the week display message
                updateWeekDisplayMessage(weekRange);
                updateDateFilterDisplay();

                displayWorkshops(currentWeekWorkshops);
                addMarkersToMap(currentWeekWorkshops);
            } catch (err) {
                document.getElementById('workshopList').innerHTML = '<p>Error loading workshops</p>';
            }
        }

        // Expand weekly events to multiple occurrences (without creating new DB records)
        function expandWeeklyEvents(workshops) {
            const expandedWorkshops = [];
            const today = new Date();
            const maxWeeksToShow = 52; // Show up to 1 year ahead

            workshops.forEach(w => {
                if (w.recurrence === 'weekly') {
                    // Create multiple occurrences for weekly events
                    const startDate = new Date(w.date + 'T00:00:00');
                    const endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + (maxWeeksToShow * 7)); // 52 weeks ahead

                    // Generate occurrences for each week
                    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 7)) {
                        const year = d.getFullYear();
                        const month = String(d.getMonth() + 1).padStart(2, '0');
                        const day = String(d.getDate()).padStart(2, '0');
                        const occurrenceDate = `${year}-${month}-${day}`;

                        // Only add if date is today or in the future
                        if (new Date(occurrenceDate + 'T00:00:00') >= today) {
                            expandedWorkshops.push({
                                ...w,
                                date: occurrenceDate,
                                isRecurringInstance: true, // Mark as recurring instance
                                originalDate: w.date // Keep original date for reference
                            });
                        }
                    }
                } else {
                    // Single events stay as-is
                    expandedWorkshops.push(w);
                }
            });

            return expandedWorkshops;
        }

        function updateWeekDisplayMessage(weekRange) {
            const startDate = new Date(weekRange.start + 'T00:00:00');
            const endDate = new Date(weekRange.end + 'T00:00:00');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const startStr = `${months[startDate.getMonth()]} ${startDate.getDate()}`;
            const endStr = `${months[endDate.getMonth()]} ${endDate.getDate()}`;
            document.getElementById('weekDisplayRange').textContent = `${startStr} ‚Äì ${endStr}, ${startDate.getFullYear()}`;
        }

        function updateDateFilterDisplay() {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            let rangeText = '';

            if (activeDateFilter.type === 'week') {
                const weekRange = getWeekDateRange();
                const startDate = new Date(weekRange.start + 'T00:00:00');
                const endDate = new Date(weekRange.end + 'T00:00:00');
                const startStr = `${months[startDate.getMonth()]} ${startDate.getDate()}`;
                const endStr = `${months[endDate.getMonth()]} ${endDate.getDate()}`;
                rangeText = `(${startStr} ‚Äì ${endStr})`;
            } else if (activeDateFilter.type === 'nextWeek') {
                const offset = activeDateFilter?.data?.offset ?? 1;
                const nextWeekRange = getNextWeekDateRange(offset);
                const startDate = new Date(nextWeekRange.start + 'T00:00:00');
                const endDate = new Date(nextWeekRange.end + 'T00:00:00');
                const startStr = `${months[startDate.getMonth()]} ${startDate.getDate()}`;
                const endStr = `${months[endDate.getMonth()]} ${endDate.getDate()}`;
                rangeText = `(${startStr} ‚Äì ${endStr})`;
            } else if (activeDateFilter.type === 'today') {
                const today = new Date().toISOString().split('T')[0];
                const dateObj = new Date(today + 'T00:00:00');
                const dateStr = `${months[dateObj.getMonth()]} ${dateObj.getDate()}`;
                rangeText = `(${dateStr})`;
            } else if (activeDateFilter.type === 'range' && activeDateFilter.data) {
                const { start, end } = activeDateFilter.data;
                const startDate = new Date(start + 'T00:00:00');
                const endDate = new Date(end + 'T00:00:00');
                const startStr = `${months[startDate.getMonth()]} ${startDate.getDate()}`;
                const endStr = `${months[endDate.getMonth()]} ${endDate.getDate()}`;
                rangeText = `(${startStr} ‚Äì ${endStr})`;
            } else if (activeDateFilter.type === 'date' && activeDateFilter.data) {
                const dateObj = new Date(activeDateFilter.data + 'T00:00:00');
                const dateStr = `${months[dateObj.getMonth()]} ${dateObj.getDate()}`;
                rangeText = `(${dateStr})`;
            }

            document.getElementById('dateFilterRange').textContent = rangeText;
        }

        function filterByCurrentWeek() {
            updateDateFilterButtons('dateCurrentWeek');
            const weekRange = getWeekDateRange();
            activeDateFilter = { type: 'week', data: null };

            const style = document.getElementById('styleFilter').value;
            const city = document.getElementById('cityFilter').value.toLowerCase();

            const filtered = allWorkshops.filter(w => {
                const matchStyle = !style || w.style === style;
                const matchCity = !city || w.city.toLowerCase().includes(city);
                const matchDate = w.date >= weekRange.start && w.date <= weekRange.end;

                // Apply workshop/party type filter
                let matchType = true;
                if (styleTypeFilter === 'workshops') {
                    matchType = w.style !== 'lets_party';
                } else if (styleTypeFilter === 'parties') {
                    matchType = w.style === 'lets_party';
                }

                return matchStyle && matchCity && matchDate && matchType;
            });

            displayWorkshops(filtered);
            addMarkersToMap(filtered);
            updateWeekDisplayMessage(weekRange);
            updateDateFilterDisplay();
            showToast(`üìÖ Showing items for current week (${weekRange.start} to ${weekRange.end})`, 'success');
        }

        function filterByPreviousWeek() {
            // Back-step from future weeks toward the current week; never allow past weeks.
            const currentOffset =
                activeDateFilter?.type === 'nextWeek'
                    ? (activeDateFilter?.data?.offset ?? 1)
                    : 0;
            const offset = Math.max(0, currentOffset - 1);

            if (offset === 0) {
                filterByCurrentWeek();
                showToast('üìÖ Reached current week', 'info');
                return;
            }

            updateDateFilterButtons('dateNextWeek');
            const weekRange = getNextWeekDateRange(offset);
            activeDateFilter = { type: 'nextWeek', data: { offset } };

            const style = document.getElementById('styleFilter').value;
            const city = document.getElementById('cityFilter').value.toLowerCase();

            const filtered = allWorkshops.filter(w => {
                const matchStyle = !style || w.style === style;
                const matchCity = !city || w.city.toLowerCase().includes(city);
                const matchDate = w.date >= weekRange.start && w.date <= weekRange.end;

                // Apply workshop/party type filter
                let matchType = true;
                if (styleTypeFilter === 'workshops') {
                    matchType = w.style !== 'lets_party';
                } else if (styleTypeFilter === 'parties') {
                    matchType = w.style === 'lets_party';
                }

                return matchStyle && matchCity && matchDate && matchType;
            });

            displayWorkshops(filtered);
            addMarkersToMap(filtered);
            updateWeekDisplayMessage(weekRange);
            updateDateFilterDisplay();
            const label = offset === 1 ? 'next week' : `in ${offset} weeks`;
            showToast(`üìÖ Showing items ${label} (${weekRange.start} to ${weekRange.end})`, 'success');
        }

        function filterByNextWeek() {
            updateDateFilterButtons('dateNextWeek');
            const currentOffset = activeDateFilter?.type === 'nextWeek' ? (activeDateFilter?.data?.offset ?? 1) : 0;
            const offset = currentOffset + 1;
            const nextWeekRange = getNextWeekDateRange(offset);
            activeDateFilter = { type: 'nextWeek', data: { offset } };

            const style = document.getElementById('styleFilter').value;
            const city = document.getElementById('cityFilter').value.toLowerCase();

            const filtered = allWorkshops.filter(w => {
                const matchStyle = !style || w.style === style;
                const matchCity = !city || w.city.toLowerCase().includes(city);
                const matchDate = w.date >= nextWeekRange.start && w.date <= nextWeekRange.end;

                // Apply workshop/party type filter
                let matchType = true;
                if (styleTypeFilter === 'workshops') {
                    matchType = w.style !== 'lets_party';
                } else if (styleTypeFilter === 'parties') {
                    matchType = w.style === 'lets_party';
                }

                return matchStyle && matchCity && matchDate && matchType;
            });

            displayWorkshops(filtered);
            addMarkersToMap(filtered);
            updateWeekDisplayMessage(nextWeekRange);
            updateDateFilterDisplay();
            const label = offset === 1 ? 'next week' : `in ${offset} weeks`;
            showToast(`üìÖ Showing items ${label} (${nextWeekRange.start} to ${nextWeekRange.end})`, 'success');
        }

        function displayWorkshops(workshops) {
            const list = document.getElementById('workshopList');
            if (workshops.length === 0) {
                list.innerHTML = '<p>No workshops found.</p>';
            } else {
                // Sort workshops by date (closest/soonest first)
                const sorted = [...workshops].sort((a, b) => {
                    return new Date(a.date) - new Date(b.date);
                });

                // Group workshops by date
                const groupedByDate = {};
                sorted.forEach(w => {
                    if (!groupedByDate[w.date]) {
                        groupedByDate[w.date] = [];
                    }
                    groupedByDate[w.date].push(w);
                });

                // Build HTML with date separators
                let html = `<p style="color: #667eea; font-weight: bold; margin-bottom: 10px;">üìä ${workshops.length} items <span style="color: #999; font-weight: normal; font-size: 12px;">(ordered by date)</span></p>`;

                Object.keys(groupedByDate).forEach(date => {
                    const dateObj = new Date(date + 'T00:00:00');
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                    const dateStr = `${dayNames[dateObj.getDay()]} ${months[dateObj.getMonth()]} ${dateObj.getDate()}`;

                    html += `<div style="background: linear-gradient(to right, #667eea20, transparent); padding: 10px 8px; margin: 15px 0 10px 0; border-left: 3px solid #667eea; border-radius: 3px;">
                        <strong style="color: #667eea; font-size: 13px;">üìÖ ${dateStr}</strong>
                    </div>`;

                    html += groupedByDate[date].map(w => `
                        <div class="workshop-item" onclick="centerOnWorkshop(${w.id})">
                            ${w.title ? `<strong style="display: block; margin-bottom: 2px;">${w.title}</strong>` : ''}
                            <strong style="color: ${styleColors[w.style]}">${w.style.toUpperCase()}</strong>
                            ${w.isRecurringInstance ? '<span style="background: #9b59b6; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold; margin-left: 5px;">üîÑ Recurring</span>' : ''}
                            ${w.cards ? `<div style="margin-top: 5px; display: flex; gap: 3px; flex-wrap: wrap;">
                                ${w.cards.split(',').map(card => {
                                    const cardName = card.trim();
                                    let badgeColor = '#667eea';
                                    if (cardName === 'Multisport') badgeColor = '#e74c3c';
                                    if (cardName === 'Coolfit') badgeColor = '#3498db';
                                    return `<span style="background: ${badgeColor}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold;">${cardName}</span>`;
                                }).join('')}
                            </div>` : ''}
                            <small>
                                
                                <strong class="workshop-location">üìç ${w.location} - ${w.city}</strong><br>
                                <span class="workshop-datetime">${formatDateWithWeekday(w.date)} at ${w.style === 'lets_party' ? (w.start_time || 'TBA') : (w.start_time && w.end_time ? w.start_time + ' - ' + w.end_time : w.time || 'TBA')}</span><br>
                                ${w.recurrence === 'weekly' ? 'üîÑ <strong>Weekly Event</strong>' : 'üìÖ <strong>Single Event</strong>'}<br>
                                ${w.style !== 'lets_party' ? `üë®‚Äçüè´ <strong>Instructors:</strong> <span class="workshop-instructor">${w.instructor_name || 'TBA'}</span><br>` : ''}
                                ${w.style !== 'lets_party' ? `üéì <strong>Level:</strong> ${w.difficulty || 'intermediate'}<br>` : ''}
                                ${w.facebook_url ? `üìò <a href="${w.facebook_url}" target="_blank" style="color: #3b5998; text-decoration: none; font-weight: bold;">Facebook Event</a><br>` : ''}
                                ${w.description ? `<em class="workshop-description" style="margin-top: 5px;">"${w.description}"</em>` : ''}
                            </small>
                        </div>
                    `).join('');
                });

                list.innerHTML = html;
            }
        }

        function addMarkersToMap(workshops) {
            // Clear existing markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            workshops.forEach(w => {
                // Check if coordinates exist and are valid
                const lat = parseFloat(w.lat);
                const lon = parseFloat(w.lon);

                // Skip workshops without valid coordinates
                if (isNaN(lat) || isNaN(lon) || lat === null || lon === null) {
                    console.warn(`Workshop "${w.location}" missing coordinates, skipping marker`);
                    return;
                }

                const markerColor = styleColors[w.style] || '#667eea';

                const marker = L.circleMarker([lat, lon], {
                    radius: 11,
                    fillColor: markerColor,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 1.0
                }).addTo(map);

                // Store workshop ID and original color on the marker
                marker.workshopId = w.id;
                marker.originalColor = markerColor;
                marker.originalRadius = 11;

                marker.bindPopup(`
                    <div style="padding: 10px; min-width: 200px; text-align: center; word-wrap: break-word; overflow-wrap: break-word;">
                        <strong style="color: ${markerColor}; font-size: 16px;">${w.style.toUpperCase()}</strong>
                        ${w.isRecurringInstance ? '<span style="background: #9b59b6; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold; margin-left: 5px;">üîÑ Recurring</span>' : ''}<br>
                        ${w.cards ? `<div style="margin-top: 8px; display: flex; gap: 5px; justify-content: center; flex-wrap: wrap;">
                            ${w.cards.split(',').map(card => {
                                const cardName = card.trim();
                                let badgeColor = '#667eea';
                                if (cardName === 'Multisport') badgeColor = '#e74c3c';
                                if (cardName === 'Coolfit') badgeColor = '#3498db';
                                return `<span style="background: ${badgeColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">${cardName}</span>`;
                            }).join('')}
                        </div>` : ''}
                        <div style="margin-top: 10px; border-top: 2px solid ${markerColor}; padding-top: 10px; text-align: left; word-wrap: break-word; overflow-wrap: break-word;">
                            ${w.title ? `<strong style="display: block; margin-bottom: 4px;">${w.title}</strong>` : ''}
                            <strong class="workshop-location" style="word-wrap: break-word;">üìç ${w.location} - ${w.city}</strong><br>
                            <span style="color: #666; word-wrap: break-word;"><span class="workshop-datetime">${formatDateWithWeekday(w.date)} at ${w.style === 'lets_party' ? (w.start_time || 'TBA') : (w.start_time && w.end_time ? w.start_time + ' - ' + w.end_time : w.time || 'TBA')}</span></span><br>
                            <span style="color: #666; word-wrap: break-word;">${w.recurrence === 'weekly' ? 'üîÑ <strong>Weekly Event</strong>' : 'üìÖ <strong>Single Event</strong>'}</span><br>
                            ${w.style !== 'lets_party' ? `<span style="color: #666; word-wrap: break-word;">üë®‚Äçüè´ <strong>Instructors:</strong> <span class="workshop-instructor">${w.instructor_name || 'TBA'}</span></span><br>` : ''}
                            ${w.style !== 'lets_party' ? `<span style="color: #666; word-wrap: break-word;">üéì <strong>Level:</strong> ${w.difficulty || 'intermediate'}</span>` : ''}
                            ${w.facebook_url ? `<br><span style="color: #666; word-wrap: break-word;">üìò <a href="${w.facebook_url}" target="_blank" style="color: #3b5998; text-decoration: none; font-weight: bold;">Facebook Event</a></span>` : ''}
                            ${w.description ? `<br><em class="workshop-description" style="margin-top: 8px; font-style: italic; word-wrap: break-word;">"${w.description}"</em>` : ''}
                        </div>
                    </div>
                `, { closeButton: true, autoClose: false, maxWidth: 300 });

                markers.push(marker);
            });
        }

        function centerOnWorkshop(workshopId) {
            const workshop = allWorkshops.find(w => w.id === workshopId);
            if (!workshop) {
                showToast('‚ùå Workshop not found', 'error');
                return;
            }

            // Check if workshop has valid coordinates
            const lat = parseFloat(workshop.lat);
            const lon = parseFloat(workshop.lon);

            if (isNaN(lat) || isNaN(lon) || lat === null || lon === null) {
                showToast(`‚ùå Workshop location data unavailable. City: ${workshop.city}`, 'warning');
                return;
            }

            // Find the marker by workshop ID
            const targetMarker = markers.find(m => m.workshopId === workshopId);

            if (targetMarker) {
                // Get the correct color for this workshop's dance style
                const workshopColor = styleColors[workshop.style] || '#667eea';
                // console.log(`üéØ Selected workshop: ${workshop.style.toUpperCase()}`);
                // console.log(`üé® Color from styleColors: ${workshopColor}`);
                // console.log(`üìç Marker originalColor: ${targetMarker.originalColor}`);

                // Center map on the marker
                map.setView(targetMarker.getLatLng(), 16);

                // Close all open popups first
                map.closePopup();

                // Reset all markers to original state
                markers.forEach(m => {
                    if (m !== targetMarker) {
                        m.setStyle({
                            radius: m.originalRadius,
                            fillColor: m.originalColor,
                            color: '#fff', // White border (original)
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 1.0,
                            fill: true,
                            dashArray: null
                        });
                    }
                });

                // Highlight the selected marker with its original dance style color, larger size and darker border
                // console.log(`üîÑ Setting fillColor to: ${workshopColor}`);

                // Remove marker from map
                map.removeLayer(targetMarker);

                // Re-add with new style
                targetMarker.addTo(map);
                targetMarker.setStyle({
                    radius: 11, // Increase size for visibility
                    fillColor: workshopColor, // Use the correct dance style color from workshop data
                    color: '#000', // Black border for contrast
                    weight: 3, // Thicker border for emphasis
                    fill: true, // Ensure fill is enabled
                    fillOpacity: 1.0, // Full opacity for fill
                    opacity: 1.0, // Full opacity for stroke
                    dashArray: null // No dashed lines
                });

                // Force redraw to update the marker on the map
                targetMarker.redraw();

                // Also directly set the SVG fill attribute to ensure it's applied
                if (targetMarker._path) {
                    targetMarker._path.setAttribute('fill', workshopColor);
                    targetMarker._path.setAttribute('fill-opacity', '1');
                    // console.log(`üé® SVG fill set directly to: ${workshopColor}`);
                }

                // console.log(`‚úÖ Marker redrawn with color: ${workshopColor}`);

                // Open the popup with a small delay to ensure map rendering is complete
                // setTimeout(() => {
                //     // Close any other popups on the map first
                //     map.eachLayer((layer) => {
                //         if (layer.closePopup) {
                //             layer.closePopup();
                //         }
                //     });

                //     // Now open the target marker's popup
                //     if (targetMarker && targetMarker.getPopup()) {
                //         targetMarker.openPopup();
                //         console.log('‚úÖ Popup opened for workshop:', workshopId);
                //     } else {
                //         console.warn('‚ùå Popup not found for workshop:', workshopId);
                //     }
                // }, 150);
            } else {
                showToast('‚ö†Ô∏è Marker not found on map', 'warning');
            }
        }

        function updateDateFilterButtons(activeId) {
            document.getElementById('dateCurrentWeek').classList.toggle('active', activeId === 'dateCurrentWeek');
            document.getElementById('dateNextWeek').classList.toggle('active', activeId === 'dateNextWeek');
            document.getElementById('dateToday').classList.toggle('active', activeId === 'dateToday');
            document.getElementById('dateSpecific').classList.toggle('active', activeId === 'dateSpecific');
        }

        function filterByType(type) {
            styleTypeFilter = type;

            // Update button states
            document.getElementById('filterAll').classList.toggle('active', type === 'all');
            document.getElementById('filterWorkshops').classList.toggle('active', type === 'workshops');
            document.getElementById('filterParties').classList.toggle('active', type === 'parties');

            // Apply filter
            filterWorkshops();
        }

        function filterWorkshops() {
            const style = document.getElementById('styleFilter').value;
            const city = document.getElementById('cityFilter').value.toLowerCase().trim();

            let filtered = allWorkshops.filter(w => {
                const matchStyle = !style || w.style === style;
                // Match city by exact match (case-insensitive) or partial match
                const matchCity = !city || w.city.toLowerCase() === city || w.city.toLowerCase().includes(city);

                // Apply workshop/party type filter
                let matchType = true;
                if (styleTypeFilter === 'workshops') {
                    matchType = w.style !== 'lets_party';
                } else if (styleTypeFilter === 'parties') {
                    matchType = w.style === 'lets_party';
                }
                // 'all' matches everything

                return matchStyle && matchCity && matchType;
            });

            // Apply active date filter
            filtered = applyActiveDateFilter(filtered);

            displayWorkshops(filtered);
            addMarkersToMap(filtered);
        }

        function applyActiveDateFilter(workshops) {
            if (activeDateFilter.type === 'week') {
                const weekRange = getWeekDateRange();
                return workshops.filter(w => w.date >= weekRange.start && w.date <= weekRange.end);
            } else if (activeDateFilter.type === 'nextWeek') {
                const offset = activeDateFilter?.data?.offset ?? 1;
                const nextWeekRange = getNextWeekDateRange(offset);
                return workshops.filter(w => w.date >= nextWeekRange.start && w.date <= nextWeekRange.end);
            } else if (activeDateFilter.type === 'today') {
                const today = new Date().toISOString().split('T')[0];
                return workshops.filter(w => w.date === today);
            } else if (activeDateFilter.type === 'range') {
                const { start, end } = activeDateFilter.data;
                return workshops.filter(w => w.date >= start && w.date <= end);
            } else if (activeDateFilter.type === 'date') {
                const specificDate = activeDateFilter.data;
                return workshops.filter(w => w.date === specificDate);
            }
            return workshops;
        }

        function toggleSpecificDateMode() {
            const specificInputs = document.getElementById('specificDateInput');
            const rangeInputs = document.getElementById('dateRangeInputs');
            rangeInputs.style.display = 'none';
            specificInputs.style.display = specificInputs.style.display === 'none' ? 'block' : 'none';
        }

        function filterByToday() {
            updateDateFilterButtons('dateToday');
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            activeDateFilter = { type: 'today', data: null };

            const style = document.getElementById('styleFilter').value;
            const city = document.getElementById('cityFilter').value.toLowerCase();

            const filtered = allWorkshops.filter(w => {
                const matchStyle = !style || w.style === style;
                const matchCity = !city || w.city.toLowerCase().includes(city);
                const matchDate = w.date === today;

                // Apply workshop/party type filter
                let matchType = true;
                if (styleTypeFilter === 'workshops') {
                    matchType = w.style !== 'lets_party';
                } else if (styleTypeFilter === 'parties') {
                    matchType = w.style === 'lets_party';
                }

                return matchStyle && matchCity && matchDate && matchType;
            });

            displayWorkshops(filtered);
            addMarkersToMap(filtered);

            // Update header to show "Today"
            const todayDate = new Date(today + 'T00:00:00');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const todayStr = `${months[todayDate.getMonth()]} ${todayDate.getDate()}, ${todayDate.getFullYear()}`;
            document.getElementById('weekDisplayRange').textContent = `Today: ${todayStr}`;
            updateDateFilterDisplay();

            showToast(`üìÖ Showing items for today (${today})`, 'success');
        }

        function filterByDateRange() {
            updateDateFilterButtons('');
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            if (!dateFrom || !dateTo) {
                showToast('‚ö†Ô∏è Please select both start and end dates', 'warning');
                return;
            }

            activeDateFilter = { type: 'range', data: { start: dateFrom, end: dateTo } };

            const style = document.getElementById('styleFilter').value;
            const city = document.getElementById('cityFilter').value.toLowerCase();

            const filtered = allWorkshops.filter(w => {
                const matchStyle = !style || w.style === style;
                const matchCity = !city || w.city.toLowerCase().includes(city);
                const matchDate = w.date >= dateFrom && w.date <= dateTo;

                // Apply workshop/party type filter
                let matchType = true;
                if (styleTypeFilter === 'workshops') {
                    matchType = w.style !== 'lets_party';
                } else if (styleTypeFilter === 'parties') {
                    matchType = w.style === 'lets_party';
                }

                return matchStyle && matchCity && matchDate && matchType;
            });

            displayWorkshops(filtered);
            addMarkersToMap(filtered);

            // Update header to show selected range
            const fromDate = new Date(dateFrom + 'T00:00:00');
            const toDate = new Date(dateTo + 'T00:00:00');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const fromStr = `${months[fromDate.getMonth()]} ${fromDate.getDate()}`;
            const toStr = `${months[toDate.getMonth()]} ${toDate.getDate()}`;
            document.getElementById('weekDisplayRange').textContent = `${fromStr} ‚Äì ${toStr}, ${toDate.getFullYear()}`;
            updateDateFilterDisplay();

            showToast(`üìÖ Showing items from ${dateFrom} to ${dateTo}`, 'success');
        }

        function filterBySpecificDate() {
            updateDateFilterButtons('dateSpecific');
            const specificDate = document.getElementById('specificDate').value;

            if (!specificDate) {
                showToast('‚ö†Ô∏è Please select a date', 'warning');
                return;
            }

            activeDateFilter = { type: 'date', data: specificDate };

            const style = document.getElementById('styleFilter').value;
            const city = document.getElementById('cityFilter').value.toLowerCase();

            const filtered = allWorkshops.filter(w => {
                const matchStyle = !style || w.style === style;
                const matchCity = !city || w.city.toLowerCase().includes(city);
                const matchDate = w.date === specificDate;

                // Apply workshop/party type filter
                let matchType = true;
                if (styleTypeFilter === 'workshops') {
                    matchType = w.style !== 'lets_party';
                } else if (styleTypeFilter === 'parties') {
                    matchType = w.style === 'lets_party';
                }

                return matchStyle && matchCity && matchDate && matchType;
            });

            displayWorkshops(filtered);
            addMarkersToMap(filtered);

            // Update header to show selected date
            const selectedDate = new Date(specificDate + 'T00:00:00');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const dateStr = `${months[selectedDate.getMonth()]} ${selectedDate.getDate()}, ${selectedDate.getFullYear()}`;
            document.getElementById('weekDisplayRange').textContent = `${dateStr}`;
            updateDateFilterDisplay();

            showToast(`üìÖ Showing items for ${specificDate}`, 'success');
        }

        function clearDateFilters() {
            updateDateFilterButtons('dateCurrentWeek');
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('specificDate').value = '';
            document.getElementById('styleFilter').value = '';
            document.getElementById('cityFilter').value = '';
            document.getElementById('dateRangeInputs').style.display = 'none';
            document.getElementById('specificDateInput').style.display = 'none';

            // Reset to current week view
            activeDateFilter = { type: 'week', data: null };
            const weekRange = getWeekDateRange();
            const filtered = allWorkshops.filter(w =>
                w.date >= weekRange.start && w.date <= weekRange.end
            );

            displayWorkshops(filtered);
            addMarkersToMap(filtered);
            updateWeekDisplayMessage(weekRange);
            updateDateFilterDisplay();
            showToast('‚úÖ Filters cleared - showing current week', 'success');
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear sessionStorage
                sessionStorage.removeItem('access_token');
                sessionStorage.removeItem('user_id');
                sessionStorage.removeItem('is_admin');
                window.location.href = '/login.html';
            }
        }

        async function registerForWorkshop(workshopId, location) {
            try {
                const res = await fetch(`/workshops/${workshopId}/register?user_id=${userId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await res.json();

                if (res.ok) {
                    showToast(`‚úÖ Registered for ${location}!`, 'success');
                    // Reload workshops to update participant count
                    setTimeout(loadWorkshops, 500);
                } else {
                    // Handle different error codes with friendly messages
                    if (res.status === 409) {
                        showToast('üé´ You\'re already registered for this workshop!', 'warning');
                    } else if (res.status === 404) {
                        showToast('‚ùå Workshop not found', 'error');
                    } else {
                        showToast(`‚ùå ${data.detail || 'Registration failed'}`, 'error');
                    }
                }
            } catch (err) {
                showToast(`‚ùå Error: ${err.message}`, 'error');
            }
        }

        // Toast notification helper
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer') || createToastContainer();
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('removing');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container';
            document.body.appendChild(container);
            return container;
        }

        // Geocode city and relocate map
        async function relocateMapToCity(cityName) {
            if (!cityName.trim()) {
                showToast('üèôÔ∏è Please enter a city name', 'warning');
                return;
            }

            try {
                // Try with User-Agent header for better compatibility
                const res = await fetch(`https://nominatim.openstreetmap.org/search?city=${encodeURIComponent(cityName)}&format=json&limit=1`, {
                    headers: {
                        'User-Agent': 'DanceWorkshopsApp/1.0'
                    }
                });

                if (!res.ok) {
                    throw new Error(`API returned ${res.status}`);
                }

                const data = await res.json();

                if (data.length > 0) {
                    const { lat, lon, display_name } = data[0];
                    const latNum = parseFloat(lat);
                    const lonNum = parseFloat(lon);

                    // Validate coordinates
                    if (!isNaN(latNum) && !isNaN(lonNum)) {
                        map.setView([latNum, lonNum], 12);
                        // Ensure map properly updates on mobile
                        setTimeout(() => {
                            map.invalidateSize();
                        }, 100);
                        showToast(`üìç Relocated to ${display_name}`, 'success');
                    } else {
                        showToast(`‚ùå Invalid coordinates received`, 'error');
                    }
                } else {
                    showToast(`‚ùå City "${cityName}" not found`, 'error');
                }
            } catch (err) {
                console.error('Geocoding error:', err);
                // Fallback: Try to relocate to a default location if the city name is recognized
                const commonCities = {
                    'sofia': [42.6977, 23.3219],
                    'berlin': [52.5200, 13.4050],
                    'paris': [48.8566, 2.3522],
                    'london': [51.5074, -0.1278],
                    'barcelona': [41.3851, 2.1734],
                    'madrid': [40.4168, -3.7038],
                    'amsterdam': [52.3676, 4.9041],
                    'prague': [50.0755, 14.4378],
                    'budapest': [47.4979, 19.0402],
                    'warsaw': [52.2297, 21.0122],
                    'vienna': [48.2082, 16.3738],
                    'rome': [41.9028, 12.4964],
                    'lisbon': [38.7223, -9.1393],
                    'athens': [37.9838, 23.7275]
                };

                const cityLower = cityName.toLowerCase().trim();
                if (commonCities[cityLower]) {
                    const [lat, lon] = commonCities[cityLower];
                    map.setView([lat, lon], 12);
                    setTimeout(() => map.invalidateSize(), 100);
                    showToast(`üìç Relocated to ${cityName}`, 'success');
                } else {
                    showToast(`‚ùå Failed to locate "${cityName}". ${err.message}`, 'error');
                }
            }
        }

        // Function to search city from button or Enter key
        function searchCity() {
            const city = document.getElementById('cityFilter').value;
            if (city.trim()) {
                relocateMapToCity(city);
                filterWorkshops();
            } else {
                showToast('üèôÔ∏è Please enter a city name', 'warning');
            }
        }

        // Add Enter key listener to cityFilter
        setTimeout(() => {
            const cityInput = document.getElementById('cityFilter');
            if (cityInput) {
                cityInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        searchCity();
                        // Blur the input on mobile to dismiss keyboard
                        document.getElementById('cityFilter').blur();
                    }
                });
            } else {
                console.warn('cityFilter element not found');
            }
        }, 100);

        // Load workshops on page load
        loadWorkshops();

        // Auto-apply Sofia city filter after a short delay to ensure data is loaded
        setTimeout(() => {
            filterWorkshops();
        }, 500);

        // Scroll to top button functionality
        const scrollBtn = document.getElementById('scrollToTopBtn');
        const sidebar = document.querySelector('.sidebar');

        // Listen for scroll on sidebar (desktop) and window (mobile)
        sidebar.addEventListener('scroll', () => {
            if (sidebar.scrollTop > 100) {
                scrollBtn.classList.add('show');
            } else {
                scrollBtn.classList.remove('show');
            }
        });

        // Also listen for window scroll on mobile
        window.addEventListener('scroll', () => {
            if (window.scrollY > 100) {
                scrollBtn.classList.add('show');
            } else {
                scrollBtn.classList.remove('show');
            }
        });

        function scrollToTop() {
            const sidebar = document.querySelector('.sidebar');
            // For desktop/tablet - scroll sidebar
            if (sidebar.scrollTop > 0) {
                sidebar.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }
            // For mobile - scroll window
            if (window.scrollY > 0) {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }
        }
    </script>
</body>
</html>

