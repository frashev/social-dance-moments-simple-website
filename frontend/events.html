<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events - SDM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }

        nav { background: #667eea; color: white; padding: 15px; text-align: center; }
        nav h1 { margin-bottom: 10px; font-size: 18px; }
        nav .nav-buttons { display: inline-block; }
        .nav-btn { background: #e74c3c; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px; transition: 0.3s; font-size: 14px; text-decoration: none; display: inline-block; }
        .nav-btn:hover { background: #c0392b; transform: scale(1.05); }
        .nav-btn-green { background: #27ae60; }
        .nav-btn-green:hover { background: #27ae60; }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        .filters-section h2 { color: #667eea; margin-bottom: 12px; font-size: 20px; }

        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; }

        .filter-group { display: flex; flex-direction: column; gap: 4px; }
        .filter-group label { font-weight: bold; color: #333; font-size: 13px; }
        .filter-group select, .filter-group input { padding: 8px; border: 1.5px solid #ddd; border-radius: 5px; font-size: 13px; transition: border-color 0.3s ease; }
        .filter-group select:focus, .filter-group input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 5px rgba(102, 126, 234, 0.2); }

        .autocomplete-container { position: relative; }
        .autocomplete-input { width: 100%; }
        .autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1.5px solid #ddd; border-top: none; border-radius: 0 0 5px 5px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); display: none; }
        .autocomplete-list.active { display: block; }
        .autocomplete-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background 0.2s ease; }
        .autocomplete-item:hover, .autocomplete-item.selected { background: #f0f0f0; }
        .autocomplete-item:last-child { border-bottom: none; }

        .filter-buttons { display: flex; gap: 10px; align-items: center; flex-shrink: 0; min-height: 36px; }
        .btn { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; font-size: 12px; white-space: nowrap; height: 36px; display: flex; align-items: center; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); }
        .btn-primary:hover { box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5); }
        .btn-secondary { background: #f0f0f0; color: #333; border: 1.5px solid #ddd; }
        .btn-secondary:hover { background: #e0e0e0; }
        .search-btn {
            background: linear-gradient(135deg, #ff7a18 0%, #af002d 74%);
            box-shadow: 0 6px 18px rgba(255, 122, 24, 0.45);
            animation: searchPulse 1.8s ease-in-out infinite;
        }
        .search-btn:hover {
            box-shadow: 0 8px 22px rgba(255, 122, 24, 0.6);
            transform: translateY(-1px);
        }
        @keyframes searchPulse {
            0% { box-shadow: 0 6px 18px rgba(255, 122, 24, 0.45); }
            50% { box-shadow: 0 10px 26px rgba(255, 122, 24, 0.7); }
            100% { box-shadow: 0 6px 18px rgba(255, 122, 24, 0.45); }
        }
        .month-controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .month-label { font-size: 12px; color: #555; background: #f5f5f5; border: 1px solid #ddd; padding: 6px 10px; border-radius: 5px; height: 36px; display: flex; align-items: center; }
        #monthPicker { height: 36px; border: 1.5px solid #ddd; border-radius: 5px; padding: 6px 8px; font-size: 12px; }

        .events-info { background: #e3f2fd; padding: 10px; border-radius: 5px; margin-bottom: 10px; margin-top: 10px; border-left: 4px solid #2196F3; color: #1565c0; }
        .events-info strong { display: block; margin-bottom: 5px;}

        .events-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }

        .event-card { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; cursor: pointer; }
        .event-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); }

        .event-photo { width: 100%; height: 400px; object-fit: contain; object-position: center;  }

        .event-photo.placeholder { display: flex; align-items: center; justify-content: center; color: white; font-size: 42px; }

        .event-content { padding: 20px; }

        .event-title { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 10px; line-height: 1.4; }

        .event-meta { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
        .event-meta-item { display: flex; align-items: center; gap: 8px; font-size: 14px; color: #666; }
        .event-meta-icon { font-size: 16px; min-width: 20px; }

        .event-organizer { background: #f0f0f0; padding: 8px 12px; border-radius: 5px; font-size: 13px; color: #555; margin-bottom: 10px; }

        .event-dates { background: #fff3e0; padding: 10px; border-radius: 5px; font-size: 13px; color: #e65100; margin-bottom: 15px; }

        .event-description { font-size: 14px; color: #666; line-height: 1.5; margin-bottom: 15px; display: -webkit-box; -webkit-line-clamp: 5; line-clamp: 5; -webkit-box-orient: vertical; overflow: hidden; }

        .event-location { background: #f5f5f5; padding: 10px; border-radius: 5px; font-size: 13px; border-left: 3px solid #667eea; color: #555; }

        .month-divider {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #667eea;
            font-weight: bold;
            font-size: 14px;
            margin: 10px 0 4px;
        }

        .month-divider::before,
        .month-divider::after {
            content: '';
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.2), rgba(102, 126, 234, 0.8));
            border-radius: 2px;
        }

        .event-link-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border-radius: 6px;
            background: linear-gradient(135deg, #3b5998 0%, #2d4373 100%);
            color: white;
            font-size: 13px;
            font-weight: bold;
            text-decoration: none;
            box-shadow: 0 4px 12px rgba(59, 89, 152, 0.35);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .event-link-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(59, 89, 152, 0.45);
        }

        .no-events { text-align: center; padding: 60px 20px; color: #999; }
        .no-events-icon { font-size: 64px; margin-bottom: 20px; }
        .no-events h3 { font-size: 20px; margin-bottom: 10px; }

        .loading { text-align: center; padding: 40px; color: #667eea; }
        .spinner { display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #mapContainer { background: white; padding: 10px; margin-top: 6px; margin-bottom: 10px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); display: block; border-left: 5px solid #667eea; }
        #mapContainer h2 { color: #667eea; margin-bottom: 15px; font-size: 22px; }
        #map { height: 450px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }

        /* Leaflet popup customization - make it smaller */
        .leaflet-popup-content-wrapper {
            padding: 0 !important;
            border-radius: 4px !important;
        }

        .leaflet-popup-content {
            margin: 8px !important;
            font-size: 12px !important;
            line-height: 1.3 !important;
        }

        .leaflet-popup-tip {
            width: 12px !important;
            height: 12px !important;
        }

        .leaflet-popup {
            margin-bottom: 15px !important;
        }

        /* Hide leaflet controls */
        .leaflet-control-container {
            display: none !important;
        }

        /* Floating scroll to events button */
        #scrollToEventsBtn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 42px;
            height: 42px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
        }

        #scrollToEventsBtn:hover {
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
            transform: translateY(-3px);
        }

        #scrollToEventsBtn.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        @media (max-width: 768px) {
            .filter-grid { grid-template-columns: 1fr; }
            .events-grid { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
            .nav-btn { padding: 8px 12px; margin-left: 5px; font-size: 12px; }
            .container { padding: 15px; }
            .event-btn { padding: 3px 6px; font-size: 12px; }
            .event-photo { height: 280px; }
            .filter-buttons { display: flex; flex-direction: row; gap: 8px; flex-wrap: wrap; }
            .filter-buttons .search-btn { width: auto; justify-content: center; }
            #toggleMapBtn { width: auto; justify-content: center; }
            .month-controls { width: 100%; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
            .month-controls .btn { width: 100%; justify-content: center; }
            #monthPicker { width: 100%; }
            .month-label { width: 100%; justify-content: center; grid-column: 1 / -1; }
        }

        @media (max-width: 480px) {
            .filter-grid { gap: 15px; }
            .events-grid { grid-template-columns: 1fr; }
            .event-card { margin: 0; }
            .event-btn { padding: 3px 6px; font-size: 12px; }
            .event-photo { height: 220px; }
            .nav-btn { padding: 6px 10px; margin-left: 3px; font-size: 12px; }
            .month-controls { grid-template-columns: repeat(2, 1fr); }
            .month-label { grid-column: 1 / -1; }
        }
    </style>
</head>
<body>
    <nav>
        <h1>Festivals & Events Map</h1>
        <div class="nav-buttons">
            <a href="/home.html" class="nav-btn nav-btn-green">Home</a>
            <a href="/map.html" class="nav-btn nav-btn-green">Workshops & Parties Map</a>
        </div>
    </nav>

    <div class="container">
        <!-- Filters Section -->
        <div class="filters-section">
            <h2>üîç Filter Events</h2>

            <div class="filter-grid">
                <div class="filter-group">
                    <label for="countryFilter">Country *</label>
                    <div class="autocomplete-container">
                        <input type="text" id="countryFilter" class="autocomplete-input" placeholder="Type or select country..." autocomplete="off">
                        <div id="countrySuggestions" class="autocomplete-list"></div>
                    </div>
                </div>

                <div class="filter-group">
                    <label for="cityFilter">City</label>
                    <select id="cityFilter">
                        <option value="">All Cities</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="dateFilterType">Date Filter Type</label>
                    <select id="dateFilterType" onchange="updateDateFilterUI()">
                        <option value="all" selected>All Dates</option>
                        <option value="range">Date Range</option>
                        <option value="exact">Exact Date</option>
                    </select>
                </div>

                <div class="filter-group" id="dateRangeContainer" style="display: none;">
                    <label for="dateFrom">From Date</label>
                    <input type="date" id="dateFrom">
                </div>

                <div class="filter-group" id="dateToContainer" style="display: none;">
                    <label for="dateTo">To Date</label>
                    <input type="date" id="dateTo">
                </div>

                <div class="filter-group" id="exactDateContainer" style="display: none;">
                    <label for="exactDate">Event Date</label>
                    <input type="date" id="exactDate">
                </div>
            </div>

            <div class="filter-buttons" style="margin-top: 12px;">
                <button class="btn btn-primary search-btn" onclick="applyFilters()">üîé Search</button>
                <button class="btn btn-primary" onclick="toggleMap()" id="toggleMapBtn">üó∫Ô∏è Show Map</button>
                <div class="month-controls">
                    <button class="btn btn-secondary" onclick="setMonthFilter(0)">üìÖ This Month</button>
                    <button class="btn btn-secondary" onclick="setMonthFilter(-1)">‚¨ÖÔ∏è Previous</button>
                    <button class="btn btn-secondary" onclick="setMonthFilter(1)">‚û°Ô∏è Next</button>
                    <button class="btn btn-secondary" onclick="setYearRangeFilter()">üóìÔ∏è 1 Year Range</button>
                    <input type="month" id="monthPicker" onchange="selectMonthFromPicker()">
                    <button class="btn btn-secondary" onclick="openMonthPicker()">üóìÔ∏è Select Month</button>
                    <span class="month-label" id="selectedMonthLabel">Selected: All Dates</span>
                </div>
            </div>
        </div>

        <!-- Map Container -->
        <div id="mapContainer">
            <h2>üìç Events Map - <span id="mapCountryName">Bulgaria</span></h2>
            <div id="map"></div>
        </div>

        <!-- Events Info -->
        <div class="events-info" id="eventsInfo" style="display: none;">
            <span id="resultsCount">Loading...</span>
        </div>

        <!-- Events Grid -->
        <div id="eventsContainer">
            <div class="loading">
                <div class="spinner"></div>
                <p style="margin-top: 15px;">Loading events...</p>
            </div>
        </div>
    </div>

    <!-- Floating Scroll to Events Button -->
    <button id="scrollToEventsBtn" onclick="scrollToEvents()">‚¨áÔ∏è</button>

    <script>
        let allEvents = [];
        let filteredEvents = [];
        let mapVisible = false;
        let selectedMonthDate = null;
        let defaultCountry = 'Bulgaria';
        let availableCountries = [];
        let countryToCities = {};
        let locationCountryMap = {};

        function formatDateInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatMonthLabel(date) {
            return date.toLocaleString('en-US', { month: 'long', year: 'numeric' });
        }

        function applyMonthSelection(date) {
            selectedMonthDate = new Date(date.getFullYear(), date.getMonth(), 1);
            const year = selectedMonthDate.getFullYear();
            const month = selectedMonthDate.getMonth();
            const startDate = new Date(year, month, 1);
            const endDate = new Date(year, month + 1, 0);

            const filterType = document.getElementById('dateFilterType');
            filterType.value = 'range';
            updateDateFilterUI();
            document.getElementById('dateFrom').value = formatDateInput(startDate);
            document.getElementById('dateTo').value = formatDateInput(endDate);

            const monthPicker = document.getElementById('monthPicker');
            monthPicker.value = `${year}-${String(month + 1).padStart(2, '0')}`;

            document.getElementById('selectedMonthLabel').textContent = `Selected: ${formatMonthLabel(selectedMonthDate)}`;
            applyFilters();
        }

        function applyYearRangeSelection(startDate) {
            const start = new Date(startDate);
            const end = new Date(startDate);
            end.setFullYear(end.getFullYear() + 1);

            const filterType = document.getElementById('dateFilterType');
            filterType.value = 'range';
            updateDateFilterUI();
            document.getElementById('dateFrom').value = formatDateInput(start);
            document.getElementById('dateTo').value = formatDateInput(end);

            document.getElementById('monthPicker').value = '';
            document.getElementById('selectedMonthLabel').textContent = 'Selected: 1 Year Range';
            selectedMonthDate = null;
            applyFilters();
        }

        function setMonthFilter(offset) {
            const baseDate = offset === 0
                ? new Date()
                : (selectedMonthDate ? new Date(selectedMonthDate) : new Date());
            baseDate.setMonth(baseDate.getMonth() + offset);
            applyMonthSelection(baseDate);
        }

        function selectMonthFromPicker() {
            const value = document.getElementById('monthPicker').value;
            if (!value) return;
            const [year, month] = value.split('-').map(Number);
            applyMonthSelection(new Date(year, month - 1, 1));
        }

        function openMonthPicker() {
            const monthPicker = document.getElementById('monthPicker');
            monthPicker.showPicker?.();
            monthPicker.focus();
        }

        function setYearRangeFilter() {
            applyYearRangeSelection(new Date());
        }

        function buildCountryCityMapping(locations) {
            const mapping = {};
            const countryLookup = {};
            (locations || []).forEach(loc => {
                const country = (loc.country || 'Unknown').trim();
                const city = (loc.city || '').trim().toLowerCase();
                const locationName = (loc.location_name || '').trim().toLowerCase();
                if (!country || !city) {
                    return;
                }
                if (locationName) {
                    countryLookup[`${locationName}::${city}`] = country;
                }
                if (!mapping[country]) {
                    mapping[country] = [];
                }
                if (!mapping[country].includes(city)) {
                    mapping[country].push(city);
                }
            });

            Object.keys(mapping).forEach(country => mapping[country].sort());
            countryToCities = mapping;
            availableCountries = Object.keys(mapping).sort();
            locationCountryMap = countryLookup;
        }

        // Country center coordinates and zoom levels
        const countryCenters = {
            'Bulgaria': { lat: 42.733883, lon: 25.48583, zoom: 7 },
            'Romania': { lat: 45.9432, lon: 24.9668, zoom: 6 },
            'Serbia': { lat: 44.0165, lon: 21.0059, zoom: 6 },
            'Greece': { lat: 39.074208, lon: 21.824312, zoom: 6 },
            'Turkey': { lat: 38.963745, lon: 35.243322, zoom: 5 }
        };

        let map = null;
        let markers = [];

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Setup country autocomplete first
                setupCountryAutocomplete();

                // Load events first (this is async)
                await loadEvents();

                // Load locations for country/city mapping
                try {
                    await loadLocations();
                } catch (err) {
                    console.warn('‚ö†Ô∏è Could not load locations data (optional):', err);
                }

                const countryInput = document.getElementById('countryFilter');
                if (availableCountries.length > 0) {
                    defaultCountry = availableCountries.includes(defaultCountry)
                        ? defaultCountry
                        : availableCountries[0];
                    countryInput.value = defaultCountry;
                } else {
                    countryInput.value = defaultCountry;
                }

                // Update city options (now that allEvents and locations are loaded)
                updateCityOptions();

                // Initialize map for selected country (hidden by default)
                initializeMap(countryInput.value || defaultCountry);
                document.getElementById('mapContainer').style.display = 'none';

                // Apply default range: today -> next year
                applyYearRangeSelection(new Date());
            } catch (err) {
                console.error('‚ùå Initialization error:', err);
                // Ensure loading message is hidden even on error
                const container = document.getElementById('eventsContainer');
                container.innerHTML = `
                    <div class="no-events">
                        <div class="no-events-icon">‚ö†Ô∏è</div>
                        <h3>Initialization Error</h3>
                        <p>Please refresh the page to try again</p>
                    </div>
                `;
            }
        });


        function setupCountryAutocomplete() {
            const input = document.getElementById('countryFilter');
            const suggestionsList = document.getElementById('countrySuggestions');

            input.addEventListener('input', function(e) {
                const value = e.target.value.trim().toLowerCase();

                if (!value) {
                    suggestionsList.classList.remove('active');
                    return;
                }

                const countries = availableCountries.length ? availableCountries : Object.keys(countryToCities);
                const matches = countries.filter(country =>
                    country.toLowerCase().includes(value)
                );

                if (matches.length === 0) {
                    suggestionsList.classList.remove('active');
                    return;
                }

                suggestionsList.innerHTML = matches.map(country => `
                    <div class="autocomplete-item" onclick="selectCountry('${country}')">
                        ${country}
                    </div>
                `).join('');
                suggestionsList.classList.add('active');
            });

            // Close suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.autocomplete-container')) {
                    suggestionsList.classList.remove('active');
                }
            });

            // Allow Enter key to confirm first suggestion
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    const firstItem = suggestionsList.querySelector('.autocomplete-item');
                    if (firstItem) {
                        firstItem.click();
                    }
                    e.preventDefault();
                }
            });
        }

        function selectCountry(country) {
            const input = document.getElementById('countryFilter');
            const suggestionsList = document.getElementById('countrySuggestions');

            input.value = country;
            suggestionsList.classList.remove('active');

            // Update cities and apply filter automatically
            updateCityOptions();
            applyFilters();

            // Update and show map
            updateMap(country);
        }

        function initializeMap(country) {
            if (map) {
                map.remove();
                map = null;
            }

            const center = countryCenters[country] || countryCenters[defaultCountry];
            map = L.map('map').setView([center.lat, center.lon], center.zoom);

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Show map container
            document.getElementById('mapContainer').classList.add('active');
            document.getElementById('mapCountryName').textContent = country;

            console.log(`üó∫Ô∏è Map initialized for ${country}`);
        }

        function updateMap(country) {
            initializeMap(country);
            renderEventMarkers();
        }

        function renderEventMarkers() {
            const selectedCountry = document.getElementById('countryFilter').value;

            // Clear existing markers
            markers.forEach(marker => {
                if (map && map.hasLayer(marker)) {
                    map.removeLayer(marker);
                }
            });
            markers = [];

            if (!map || !filteredEvents || filteredEvents.length === 0) {
                console.log('üìç No events to display on map');
                return;
            }

            // Add markers for filtered events
            filteredEvents.forEach(event => {
                const lat = parseFloat(event.lat);
                const lon = parseFloat(event.lon);

                if (isNaN(lat) || isNaN(lon) || lat === null || lon === null) {
                    console.warn(`üìç Event "${event.title}" missing coordinates`);
                    return;
                }

                // Create circle marker
                const marker = L.circleMarker([lat, lon], {
                    radius: 10,
                    fillColor: '#e74c3c',
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.9
                }).addTo(map);

                // Create popup
                const popupContent = `
                    <div style="padding: 12px; min-width: 250px; word-wrap: break-word;">
                        <strong style="color: #e74c3c; font-size: 16px;">üéâ ${escapeHtml(event.title)}</strong><br>
                        <div style="margin-top: 8px; border-top: 2px solid #e74c3c; padding-top: 8px;">
                            <strong>üë§Hosted by ${escapeHtml(event.event_organizer)}</strong><br>
                            <span style="color: #666;">üìç ${escapeHtml(event.location)}, ${escapeHtml(event.city)}</span><br>
                            <span style="color: #666;">üìÖ Start: ${formatDate(event.start_date)} at ${formatTime(event.start_time)}</span><br>
                            <span style="color: #666;">üìÖ End: ${formatDate(event.end_date)} at ${formatTime(event.end_time)}</span><br>
                            ${event.facebook_url ? `<br><a href="${escapeHtml(event.facebook_url)}" target="_blank" style="color: #3b5998; text-decoration: none; font-weight: bold;">üìò Facebook or Event URL</a>` : ''}
                        </div>
                    </div>
                `;

                marker.bindPopup(popupContent, { closeButton: true, autoClose: false, maxWidth: 300 });
                marker.on('mouseover', function() {
                    this.setStyle({ radius: 14, fillOpacity: 1 });
                });
                marker.on('mouseout', function() {
                    this.setStyle({ radius: 10, fillOpacity: 0.9 });
                });

                markers.push(marker);
            });

            console.log(`üìç Added ${markers.length} event markers to map`);

            // Fit map bounds to show all markers
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        async function loadEvents() {
            try {
                console.log('üì° Fetching events...');
                const res = await fetch('/events');
                if (!res.ok) throw new Error('Failed to load events');

                const data = await res.json();
                allEvents = data.events || [];
                console.log(`‚úÖ Loaded ${allEvents.length} events`);
                return true;
            } catch (err) {
                console.error('‚ùå Error loading events:', err);
                // Still set allEvents to empty array so renderEvents can display error
                allEvents = [];
                const container = document.getElementById('eventsContainer');
                container.innerHTML = `
                    <div class="no-events">
                        <div class="no-events-icon">‚ö†Ô∏è</div>
                        <h3>Error Loading Events</h3>
                        <p>${err.message}</p>
                    </div>
                `;
                return false;
            }
        }

        async function loadLocations() {
            try {
                console.log('üì° Fetching locations...');
                const res = await fetch('/locations');
                if (!res.ok) {
                    console.warn('‚ö†Ô∏è Failed to load locations:', res.status);
                    return;
                }

                const data = await res.json();
                buildCountryCityMapping(data.locations || []);
                console.log(`‚úÖ Loaded locations:`, data.locations);
            } catch (err) {
                console.warn('‚ö†Ô∏è Error loading locations (non-critical):', err.message);
                // Don't throw - this is optional data
            }
        }

        function getEventCountry(event) {
            if (event.country) {
                return `${escapeHtml(event.country)}, `;
            }
            const city = (event.city || '').trim().toLowerCase();
            const locationName = (event.location || '').trim().toLowerCase();
            if (!city || !locationName) {
                return '';
            }
            const fallbackCountry = locationCountryMap[`${locationName}::${city}`];
            return fallbackCountry ? `${escapeHtml(fallbackCountry)}, ` : '';
        }

        function updateCityOptions() {
            const selectedCountry = document.getElementById('countryFilter').value;
            const citySelect = document.getElementById('cityFilter');
            const currentValue = citySelect.value;

            // Get cities for selected country from mapping
            let availableCities = [];
            if (selectedCountry && countryToCities[selectedCountry] && countryToCities[selectedCountry].length > 0) {
                // Get only cities that actually have events
                availableCities = [...new Set(
                    allEvents
                        .filter(event => countryToCities[selectedCountry].includes(event.city.toLowerCase()))
                        .map(event => event.city.toLowerCase())
                        .filter(city => city)
                        .sort()
                )];
            } else if (!selectedCountry) {
                availableCities = [...new Set(
                    allEvents
                        .map(event => event.city.toLowerCase())
                        .filter(city => city)
                        .sort()
                )];
            }

            // Preserve current selection if still available
            citySelect.innerHTML = '<option value="">All Cities</option>';
            availableCities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city.charAt(0).toUpperCase() + city.slice(1);
                citySelect.appendChild(option);
            });

            // Restore previous selection if still available
            if (availableCities.includes(currentValue)) {
                citySelect.value = currentValue;
            } else {
                citySelect.value = '';
            }
        }

        function updateDateFilterUI() {
            const filterType = document.getElementById('dateFilterType').value;
            const rangeContainer = document.getElementById('dateRangeContainer');
            const toContainer = document.getElementById('dateToContainer');
            const exactContainer = document.getElementById('exactDateContainer');

            rangeContainer.style.display = filterType === 'range' ? 'flex' : 'none';
            toContainer.style.display = filterType === 'range' ? 'flex' : 'none';
            exactContainer.style.display = filterType === 'exact' ? 'flex' : 'none';

            // Clear values when switching modes
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('exactDate').value = '';
        }

        function applyFilters() {
            const selectedCountry = document.getElementById('countryFilter').value;
            const selectedCity = document.getElementById('cityFilter').value;
            const dateFilterType = document.getElementById('dateFilterType').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const exactDate = document.getElementById('exactDate').value;

            console.log('üîç Applying filters:', { selectedCountry, selectedCity, dateFilterType, dateFrom, dateTo, exactDate });

            filteredEvents = allEvents.filter(event => {
                // Country filter - check if event city is in selected country
            if (selectedCountry && countryToCities[selectedCountry] && countryToCities[selectedCountry].length > 0) {
                const citiesInCountry = countryToCities[selectedCountry];
                if (!citiesInCountry.includes(event.city.toLowerCase())) {
                    return false;
                }
            }

                // City filter
                if (selectedCity && event.city.toLowerCase() !== selectedCity.toLowerCase()) {
                    return false;
                }

                // Date filter
                if (dateFilterType === 'range') {
                    const eventStartDate = event.start_date;
                    const eventEndDate = event.end_date;

                    // Check for overlap between the selected date range and event date range
                    // Events overlap if: eventStart <= filterEnd AND eventEnd >= filterStart
                    if (dateFrom && dateTo) {
                        // Both From and To dates specified: check if event overlaps with [dateFrom, dateTo]
                        if (eventEndDate < dateFrom || eventStartDate > dateTo) {
                            return false;
                        }
                    } else if (dateFrom) {
                        // Only From date specified: check if event ends on or after dateFrom
                        if (eventEndDate < dateFrom) {
                            return false;
                        }
                    } else if (dateTo) {
                        // Only To date specified: check if event starts on or before dateTo
                        if (eventStartDate > dateTo) {
                            return false;
                        }
                    }
                } else if (dateFilterType === 'exact') {
                    // Exact date filter: show events that have any overlap with the selected date
                    // The date must fall within the event's start_date to end_date range (inclusive)
                    if (exactDate) {
                        const eventStartDate = event.start_date;
                        const eventEndDate = event.end_date;
                        if (exactDate < eventStartDate || exactDate > eventEndDate) {
                            return false;
                        }
                    }
                }

                return true;
            });

            console.log(`‚úÖ Filtered to ${filteredEvents.length} events`);
            renderEvents();
            renderEventMarkers();

            // Show the floating scroll button if there are events found
            const scrollBtn = document.getElementById('scrollToEventsBtn');
            if (filteredEvents.length > 0) {
                scrollBtn.classList.add('show');
                console.log('üìç Scroll to events button shown');
            } else {
                scrollBtn.classList.remove('show');
            }
        }

        function resetFilters() {
            document.getElementById('countryFilter').value = defaultCountry;
            document.getElementById('cityFilter').value = '';
            document.getElementById('dateFilterType').value = 'range';
            document.getElementById('exactDate').value = '';
            updateDateFilterUI();
            updateCityOptions();
            applyYearRangeSelection(new Date());
        }

        function toggleMap() {
            const mapContainer = document.getElementById('mapContainer');
            const toggleBtn = document.getElementById('toggleMapBtn');

            mapVisible = !mapVisible;

            if (mapVisible) {
                mapContainer.style.display = 'block';
                toggleBtn.textContent = 'üó∫Ô∏è Hide Map';
                console.log('üìç Map shown');
            } else {
                mapContainer.style.display = 'none';
                toggleBtn.textContent = 'üó∫Ô∏è Show Map';
                console.log('üìç Map hidden');
            }
        }

        function renderEvents() {
            const container = document.getElementById('eventsContainer');
            const info = document.getElementById('eventsInfo');

            if (filteredEvents.length === 0) {
                container.innerHTML = `
                    <div class="no-events">
                        <div class="no-events-icon">üé≠</div>
                        <h3>No Events Found</h3>
                        <p>Try adjusting your filters to find more events</p>
                    </div>
                `;
                info.style.display = 'none';
                return;
            }

            info.innerHTML = `Found <span style="color: #2196F3; font-weight: bold;">${filteredEvents.length}</span> event(s)`;
            info.style.display = 'block';

            // Sort events by start_date and start_time
            const sortedEvents = [...filteredEvents].sort((a, b) => {
                const dateCompare = a.start_date.localeCompare(b.start_date);
                if (dateCompare !== 0) return dateCompare;
                const timeCompare = a.start_time.localeCompare(b.start_time);
                if (timeCompare !== 0) return timeCompare;
                return a.end_time.localeCompare(b.end_time);
            });

            let currentMonthLabel = '';
            const cards = sortedEvents.map(event => {
                const monthLabel = formatMonthYear(event.start_date);
                let monthHeader = '';
                if (monthLabel !== currentMonthLabel) {
                    currentMonthLabel = monthLabel;
                    monthHeader = `<div class="month-divider">${escapeHtml(monthLabel)}</div>`;
                }
                return `${monthHeader}${createEventCard(event)}`;
            });

            container.innerHTML = cards.join('');
        }

        function createEventCard(event) {
            const startDate = formatDate(event.start_date);
            const endDate = formatDate(event.end_date);
            const startTime = formatTime(event.start_time);
            const endTime = formatTime(event.end_time);
            const countryLabel = getEventCountry(event);
            const photoHtml = event.photo_path
                ? `<img src="/${event.photo_path}" alt="${event.title}" class="event-photo">`
                : `<div class="event-photo placeholder">üéâ</div>`;

            return `
                <div class="event-card">
                    ${photoHtml}
                    <div class="event-content">
                        <div class="event-title">${escapeHtml(event.title)}</div>

                        <div class="event-meta">
                            <div class="event-meta-item">
                                <span class="event-meta-icon">üìç</span>
                                <span>${escapeHtml(event.location)}, ${countryLabel}${escapeHtml(event.city)}</span>
                            </div>
                        </div>

                        <div class="event-organizer">üë§ Hosted by ${escapeHtml(event.event_organizer)}</div>

                        <div class="event-dates">
                            <div><strong>üìÖ Start:</strong> ${startDate} at ${startTime}</div>
                            <div><strong>üìÖ End:</strong> ${endDate} at ${endTime}</div>
                        </div>

                        ${event.facebook_url ? `<div style="margin-bottom: 10px;"><a class="event-link-btn" href="${escapeHtml(event.facebook_url)}" target="_blank" rel="noopener">üìò Facebook or Event URL</a></div>` : ''}

                        ${event.description ? `<div class="event-description">${escapeHtml(event.description)}</div>` : ''}

                    </div>
                </div>
            `;
        }


        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
        }

        function formatMonthYear(dateStr) {
            if (!dateStr) return 'Unknown Month';
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        }

        function formatTime(timeStr) {
            if (!timeStr) return 'N/A';
            return timeStr;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function scrollToEvents() {
            const eventsContainer = document.getElementById('eventsInfo');
            const scrollBtn = document.getElementById('scrollToEventsBtn');

            eventsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            console.log('‚¨áÔ∏è Scrolled to events section');

            // Hide the button after clicking
            scrollBtn.classList.remove('show');
            console.log('üîò Arrow button hidden');
        }
    </script>
</body>
</html>

