<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events - SDM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }

        nav { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px; text-align: center; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
        nav h1 { margin-bottom: 10px; font-size: 20px; }
        nav .nav-buttons { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .nav-btn { background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; padding: 4px 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; text-decoration: none; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3); font-size: 13px; }
        .nav-btn:hover { box-shadow: 0 6px 20px rgba(39, 174, 96, 0.5); }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        .filters-section h2 { color: #667eea; margin-bottom: 12px; font-size: 20px; }

        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; }

        .filter-group { display: flex; flex-direction: column; gap: 4px; }
        .filter-group label { font-weight: bold; color: #333; font-size: 13px; }
        .filter-group select, .filter-group input { padding: 8px; border: 1.5px solid #ddd; border-radius: 5px; font-size: 13px; transition: border-color 0.3s ease; }
        .filter-group select:focus, .filter-group input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 5px rgba(102, 126, 234, 0.2); }

        .autocomplete-container { position: relative; }
        .autocomplete-input { width: 100%; }
        .autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1.5px solid #ddd; border-top: none; border-radius: 0 0 5px 5px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); display: none; }
        .autocomplete-list.active { display: block; }
        .autocomplete-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background 0.2s ease; }
        .autocomplete-item:hover, .autocomplete-item.selected { background: #f0f0f0; }
        .autocomplete-item:last-child { border-bottom: none; }

        .filter-buttons { display: flex; gap: 10px; align-items: center; flex-shrink: 0; min-height: 36px; }
        .btn { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; font-size: 11px; white-space: nowrap; height: 36px; display: flex; align-items: center; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); }
        .btn-primary:hover { box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5); }
        .btn-secondary { background: #f0f0f0; color: #333; border: 1.5px solid #ddd; }
        .btn-secondary:hover { background: #e0e0e0; }

        .events-info { background: #e3f2fd; padding: 10px; border-radius: 5px; margin-bottom: 10px; margin-top: 10px; border-left: 4px solid #2196F3; color: #1565c0; }
        .events-info strong { display: block; margin-bottom: 5px;}

        .events-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }

        .event-card { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; cursor: pointer; }
        .event-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); }

        .event-photo { width: 100%; height: 200px; object-fit: cover; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 48px; }

        .event-content { padding: 20px; }

        .event-title { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 10px; line-height: 1.4; }

        .event-meta { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
        .event-meta-item { display: flex; align-items: center; gap: 8px; font-size: 14px; color: #666; }
        .event-meta-icon { font-size: 16px; min-width: 20px; }

        .event-organizer { background: #f0f0f0; padding: 8px 12px; border-radius: 5px; font-size: 13px; color: #555; margin-bottom: 10px; }

        .event-dates { background: #fff3e0; padding: 10px; border-radius: 5px; font-size: 13px; color: #e65100; margin-bottom: 15px; }

        .event-description { font-size: 14px; color: #666; line-height: 1.5; margin-bottom: 15px; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; }

        .event-location { background: #f5f5f5; padding: 10px; border-radius: 5px; font-size: 13px; border-left: 3px solid #667eea; color: #555; }

        .no-events { text-align: center; padding: 60px 20px; color: #999; }
        .no-events-icon { font-size: 64px; margin-bottom: 20px; }
        .no-events h3 { font-size: 20px; margin-bottom: 10px; }

        .loading { text-align: center; padding: 40px; color: #667eea; }
        .spinner { display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #mapContainer { background: white; padding: 10px; margin-top: 6px; margin-bottom: 10px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); display: block; border-left: 5px solid #667eea; }
        #mapContainer h2 { color: #667eea; margin-bottom: 15px; font-size: 22px; }
        #map { height: 400px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }

        @media (max-width: 768px) {
            .filter-grid { grid-template-columns: 1fr; }
            .events-grid { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
            nav h1 { font-size: 22px; }
            .container { padding: 15px; }
            .event-btn { padding: 3px 6px; font-size: 11px; }
        }

        @media (max-width: 480px) {
            .filter-grid { gap: 15px; }
            .events-grid { grid-template-columns: 1fr; }
            .event-card { margin: 0; }
            .event-btn { padding: 3px 6px; font-size: 11px; }
        }
    </style>
</head>
<body>
    <nav>
        <h1>Festivals & Events Map</h1>
        <div class="nav-buttons">
            <a href="/home.html" class="nav-btn">Home</a>
            <a href="/map.html" class="nav-btn">View Workshops & Parties Map</a>
        </div>
    </nav>

    <div class="container">
        <!-- Filters Section -->
        <div class="filters-section">
            <h2>üîç Filter Events</h2>

            <div class="filter-grid">
                <div class="filter-group">
                    <label for="countryFilter">Country *</label>
                    <div class="autocomplete-container">
                        <input type="text" id="countryFilter" class="autocomplete-input" placeholder="Type or select country..." autocomplete="off">
                        <div id="countrySuggestions" class="autocomplete-list"></div>
                    </div>
                </div>

                <div class="filter-group">
                    <label for="cityFilter">City</label>
                    <select id="cityFilter">
                        <option value="">All Cities</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="dateFilterType">Date Filter Type</label>
                    <select id="dateFilterType" onchange="updateDateFilterUI()">
                        <option value="all" selected>All Dates</option>
                        <option value="range">Date Range</option>
                        <option value="exact">Exact Date</option>
                    </select>
                </div>

                <div class="filter-group" id="dateRangeContainer" style="display: none;">
                    <label for="dateFrom">From Date</label>
                    <input type="date" id="dateFrom">
                </div>

                <div class="filter-group" id="dateToContainer" style="display: none;">
                    <label for="dateTo">To Date</label>
                    <input type="date" id="dateTo">
                </div>

                <div class="filter-group" id="exactDateContainer" style="display: none;">
                    <label for="exactDate">Event Date</label>
                    <input type="date" id="exactDate">
                </div>
            </div>

            <div class="filter-buttons" style="margin-top: 12px;">
                <button class="btn btn-primary" onclick="applyFilters()">üîé Search</button>
                <button class="btn btn-primary" onclick="toggleMap()" id="toggleMapBtn">üó∫Ô∏è Hide Map</button>
                <button class="btn btn-secondary" onclick="resetFilters()">‚Ü∫ Reset</button>
            </div>
        </div>

        <!-- Map Container -->
        <div id="mapContainer">
            <h2>üìç Events Map - <span id="mapCountryName">Bulgaria</span></h2>
            <div id="map"></div>
        </div>

        <!-- Events Info -->
        <div class="events-info" id="eventsInfo" style="display: none;">
            <span id="resultsCount">Loading...</span>
        </div>

        <!-- Events Grid -->
        <div id="eventsContainer">
            <div class="loading">
                <div class="spinner"></div>
                <p style="margin-top: 15px;">Loading events...</p>
            </div>
        </div>
    </div>

    <script>
        let allEvents = [];
        let filteredEvents = [];
        const DEFAULT_COUNTRY = 'Bulgaria';
        let mapVisible = true;

        // Country-to-cities mapping
        const countryToCities = {
            'Bulgaria': ['sofia', 'plovdiv', 'varna', 'burgas', 'ruse', 'stara zagora', 'pleven'],
            'Romania': ['bucharest', 'cluj-napoca', 'timisoara', 'iasi', 'constanta', 'brasov', 'galati'],
            'Serbia': ['belgrade', 'novi sad', 'nis', 'zemun', 'subotica', 'smederevo'],
            'Greece': ['athens', 'thessaloniki', 'patras', 'heraklion', 'larissa', 'volos'],
            'Turkey': ['istanbul', 'ankara', 'izmir', 'antalya', 'bursa', 'gaziantep']
        };

        // Country center coordinates and zoom levels
        const countryCenters = {
            'Bulgaria': { lat: 42.733883, lon: 25.48583, zoom: 7 },
            'Romania': { lat: 45.9432, lon: 24.9668, zoom: 6 },
            'Serbia': { lat: 44.0165, lon: 21.0059, zoom: 6 },
            'Greece': { lat: 39.074208, lon: 21.824312, zoom: 6 },
            'Turkey': { lat: 38.963745, lon: 35.243322, zoom: 5 }
        };

        let map = null;
        let markers = [];

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Setup country autocomplete first
                setupCountryAutocomplete();

                // Load events first (this is async)
                await loadEvents();

                // Load cities (optional - not blocking)
                try {
                    await loadCities();
                } catch (err) {
                    console.warn('‚ö†Ô∏è Could not load cities data (optional):', err);
                }

                // Prepopulate with Bulgaria
                const countryInput = document.getElementById('countryFilter');
                countryInput.value = DEFAULT_COUNTRY;

                // Update city options for Bulgaria (now that allEvents is loaded)
                updateCityOptions();

                // Initialize map for Bulgaria
                initializeMap(DEFAULT_COUNTRY);

                // Apply initial filters
                applyFilters();
            } catch (err) {
                console.error('‚ùå Initialization error:', err);
                // Ensure loading message is hidden even on error
                const container = document.getElementById('eventsContainer');
                container.innerHTML = `
                    <div class="no-events">
                        <div class="no-events-icon">‚ö†Ô∏è</div>
                        <h3>Initialization Error</h3>
                        <p>Please refresh the page to try again</p>
                    </div>
                `;
            }
        });


        function setupCountryAutocomplete() {
            const input = document.getElementById('countryFilter');
            const suggestionsList = document.getElementById('countrySuggestions');
            const countries = Object.keys(countryToCities);

            input.addEventListener('input', function(e) {
                const value = e.target.value.trim().toLowerCase();

                if (!value) {
                    suggestionsList.classList.remove('active');
                    return;
                }

                const matches = countries.filter(country =>
                    country.toLowerCase().includes(value)
                );

                if (matches.length === 0) {
                    suggestionsList.classList.remove('active');
                    return;
                }

                suggestionsList.innerHTML = matches.map(country => `
                    <div class="autocomplete-item" onclick="selectCountry('${country}')">
                        ${country}
                    </div>
                `).join('');
                suggestionsList.classList.add('active');
            });

            // Close suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.autocomplete-container')) {
                    suggestionsList.classList.remove('active');
                }
            });

            // Allow Enter key to confirm first suggestion
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    const firstItem = suggestionsList.querySelector('.autocomplete-item');
                    if (firstItem) {
                        firstItem.click();
                    }
                    e.preventDefault();
                }
            });
        }

        function selectCountry(country) {
            const input = document.getElementById('countryFilter');
            const suggestionsList = document.getElementById('countrySuggestions');

            input.value = country;
            suggestionsList.classList.remove('active');

            // Update cities and apply filter automatically
            updateCityOptions();
            applyFilters();

            // Update and show map
            updateMap(country);
        }

        function initializeMap(country) {
            if (map) {
                map.remove();
                map = null;
            }

            const center = countryCenters[country] || countryCenters[DEFAULT_COUNTRY];
            map = L.map('map').setView([center.lat, center.lon], center.zoom);

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Show map container
            document.getElementById('mapContainer').classList.add('active');
            document.getElementById('mapCountryName').textContent = country;

            console.log(`üó∫Ô∏è Map initialized for ${country}`);
        }

        function updateMap(country) {
            initializeMap(country);
            renderEventMarkers();
        }

        function renderEventMarkers() {
            const selectedCountry = document.getElementById('countryFilter').value;

            // Clear existing markers
            markers.forEach(marker => {
                if (map && map.hasLayer(marker)) {
                    map.removeLayer(marker);
                }
            });
            markers = [];

            if (!map || !filteredEvents || filteredEvents.length === 0) {
                console.log('üìç No events to display on map');
                return;
            }

            // Add markers for filtered events
            filteredEvents.forEach(event => {
                const lat = parseFloat(event.lat);
                const lon = parseFloat(event.lon);

                if (isNaN(lat) || isNaN(lon) || lat === null || lon === null) {
                    console.warn(`üìç Event "${event.title}" missing coordinates`);
                    return;
                }

                // Create circle marker
                const marker = L.circleMarker([lat, lon], {
                    radius: 10,
                    fillColor: '#e74c3c',
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.9
                }).addTo(map);

                // Create popup
                const popupContent = `
                    <div style="padding: 12px; min-width: 250px; word-wrap: break-word;">
                        <strong style="color: #e74c3c; font-size: 16px;">üéâ ${escapeHtml(event.title)}</strong><br>
                        <div style="margin-top: 8px; border-top: 2px solid #e74c3c; padding-top: 8px;">
                            <strong>üë§ ${escapeHtml(event.event_organizer)}</strong><br>
                            <span style="color: #666;">üìç ${escapeHtml(event.location)}, ${escapeHtml(event.city)}</span><br>
                            <span style="color: #666;">üìÖ ${formatDate(event.start_date)} at ${formatTime(event.start_time)}</span><br>
                            ${event.description ? `<em style="color: #555; display: block; margin-top: 8px;">"${escapeHtml(event.description)}"</em>` : ''}
                            ${event.facebook_url ? `<br><a href="${escapeHtml(event.facebook_url)}" target="_blank" style="color: #3b5998; text-decoration: none; font-weight: bold;">üìò Facebook</a>` : ''}
                        </div>
                    </div>
                `;

                marker.bindPopup(popupContent, { closeButton: true, autoClose: false, maxWidth: 300 });
                marker.on('mouseover', function() {
                    this.setStyle({ radius: 14, fillOpacity: 1 });
                });
                marker.on('mouseout', function() {
                    this.setStyle({ radius: 10, fillOpacity: 0.9 });
                });

                markers.push(marker);
            });

            console.log(`üìç Added ${markers.length} event markers to map`);

            // Fit map bounds to show all markers
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        async function loadEvents() {
            try {
                console.log('üì° Fetching events...');
                const res = await fetch('/events');
                if (!res.ok) throw new Error('Failed to load events');

                const data = await res.json();
                allEvents = data.events || [];
                console.log(`‚úÖ Loaded ${allEvents.length} events`);
                return true;
            } catch (err) {
                console.error('‚ùå Error loading events:', err);
                // Still set allEvents to empty array so renderEvents can display error
                allEvents = [];
                const container = document.getElementById('eventsContainer');
                container.innerHTML = `
                    <div class="no-events">
                        <div class="no-events-icon">‚ö†Ô∏è</div>
                        <h3>Error Loading Events</h3>
                        <p>${err.message}</p>
                    </div>
                `;
                return false;
            }
        }

        async function loadCities() {
            try {
                console.log('üì° Fetching cities...');
                const token = sessionStorage.getItem('access_token');

                // Skip if no token (user not authenticated)
                if (!token) {
                    console.warn('‚ö†Ô∏è No authentication token, skipping cities load');
                    return;
                }

                const res = await fetch(`/admin/locations?token=${encodeURIComponent(token)}`);
                if (!res.ok) {
                    console.warn('‚ö†Ô∏è Failed to load locations:', res.status);
                    return;
                }

                const data = await res.json();
                console.log(`‚úÖ Loaded locations:`, data.locations);
            } catch (err) {
                console.warn('‚ö†Ô∏è Error loading cities (non-critical):', err.message);
                // Don't throw - this is optional data
            }
        }

        function updateCityOptions() {
            const selectedCountry = document.getElementById('countryFilter').value;
            const citySelect = document.getElementById('cityFilter');
            const currentValue = citySelect.value;

            // Get cities for selected country from mapping
            let availableCities = [];
            if (selectedCountry && countryToCities[selectedCountry]) {
                // Get only cities that actually have events
                availableCities = [...new Set(
                    allEvents
                        .filter(event => countryToCities[selectedCountry].includes(event.city.toLowerCase()))
                        .map(event => event.city.toLowerCase())
                        .filter(city => city)
                        .sort()
                )];
            }

            // Preserve current selection if still available
            citySelect.innerHTML = '<option value="">All Cities</option>';
            availableCities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city.charAt(0).toUpperCase() + city.slice(1);
                citySelect.appendChild(option);
            });

            // Restore previous selection if still available
            if (availableCities.includes(currentValue)) {
                citySelect.value = currentValue;
            } else {
                citySelect.value = '';
            }
        }

        function updateDateFilterUI() {
            const filterType = document.getElementById('dateFilterType').value;
            const rangeContainer = document.getElementById('dateRangeContainer');
            const toContainer = document.getElementById('dateToContainer');
            const exactContainer = document.getElementById('exactDateContainer');

            rangeContainer.style.display = filterType === 'range' ? 'flex' : 'none';
            toContainer.style.display = filterType === 'range' ? 'flex' : 'none';
            exactContainer.style.display = filterType === 'exact' ? 'flex' : 'none';

            // Clear values when switching modes
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('exactDate').value = '';
        }

        function applyFilters() {
            const selectedCountry = document.getElementById('countryFilter').value;
            const selectedCity = document.getElementById('cityFilter').value;
            const dateFilterType = document.getElementById('dateFilterType').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const exactDate = document.getElementById('exactDate').value;

            console.log('üîç Applying filters:', { selectedCountry, selectedCity, dateFilterType, dateFrom, dateTo, exactDate });

            filteredEvents = allEvents.filter(event => {
                // Country filter - check if event city is in selected country
                if (selectedCountry) {
                    const citiesInCountry = countryToCities[selectedCountry] || [];
                    if (!citiesInCountry.includes(event.city.toLowerCase())) {
                        return false;
                    }
                }

                // City filter
                if (selectedCity && event.city.toLowerCase() !== selectedCity.toLowerCase()) {
                    return false;
                }

                // Date filter
                if (dateFilterType === 'range') {
                    const eventStartDate = event.start_date;
                    const eventEndDate = event.end_date;

                    // Check for overlap between the selected date range and event date range
                    // Events overlap if: eventStart <= filterEnd AND eventEnd >= filterStart
                    if (dateFrom && dateTo) {
                        // Both From and To dates specified: check if event overlaps with [dateFrom, dateTo]
                        if (eventEndDate < dateFrom || eventStartDate > dateTo) {
                            return false;
                        }
                    } else if (dateFrom) {
                        // Only From date specified: check if event ends on or after dateFrom
                        if (eventEndDate < dateFrom) {
                            return false;
                        }
                    } else if (dateTo) {
                        // Only To date specified: check if event starts on or before dateTo
                        if (eventStartDate > dateTo) {
                            return false;
                        }
                    }
                } else if (dateFilterType === 'exact') {
                    if (exactDate && event.start_date !== exactDate) return false;
                }

                return true;
            });

            console.log(`‚úÖ Filtered to ${filteredEvents.length} events`);
            renderEvents();
            renderEventMarkers();
        }

        function resetFilters() {
            document.getElementById('countryFilter').value = DEFAULT_COUNTRY;
            document.getElementById('cityFilter').value = '';
            document.getElementById('dateFilterType').value = 'all';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('exactDate').value = '';
            updateDateFilterUI();
            updateCityOptions();
            applyFilters();
        }

        function toggleMap() {
            const mapContainer = document.getElementById('mapContainer');
            const toggleBtn = document.getElementById('toggleMapBtn');

            mapVisible = !mapVisible;

            if (mapVisible) {
                mapContainer.style.display = 'block';
                toggleBtn.textContent = 'üó∫Ô∏è Hide Map';
                console.log('üìç Map shown');
            } else {
                mapContainer.style.display = 'none';
                toggleBtn.textContent = 'üó∫Ô∏è Show Map';
                console.log('üìç Map hidden');
            }
        }

        function renderEvents() {
            const container = document.getElementById('eventsContainer');
            const info = document.getElementById('eventsInfo');

            if (filteredEvents.length === 0) {
                container.innerHTML = `
                    <div class="no-events">
                        <div class="no-events-icon">üé≠</div>
                        <h3>No Events Found</h3>
                        <p>Try adjusting your filters to find more events</p>
                    </div>
                `;
                info.style.display = 'none';
                return;
            }

            info.innerHTML = `Found <span style="color: #2196F3; font-weight: bold;">${filteredEvents.length}</span> event(s)`;
            info.style.display = 'block';

            // Sort events by start_date and start_time
            const sortedEvents = [...filteredEvents].sort((a, b) => {
                const dateCompare = a.start_date.localeCompare(b.start_date);
                if (dateCompare !== 0) return dateCompare;
                return a.start_time.localeCompare(b.start_time);
            });

            container.innerHTML = sortedEvents.map(event => createEventCard(event)).join('');
        }

        function createEventCard(event) {
            const startDate = formatDate(event.start_date);
            const endDate = formatDate(event.end_date);
            const startTime = formatTime(event.start_time);
            const endTime = formatTime(event.end_time);
            const photoHtml = event.photo_path
                ? `<img src="/${event.photo_path}" alt="${event.title}" class="event-photo">`
                : `<div class="event-photo">üéâ</div>`;

            return `
                <div class="event-card">
                    ${photoHtml}
                    <div class="event-content">
                        <div class="event-title">${escapeHtml(event.title)}</div>

                        <div class="event-meta">
                            <div class="event-meta-item">
                                <span class="event-meta-icon">üìç</span>
                                <span>${escapeHtml(event.location)}, ${escapeHtml(event.city)}</span>
                            </div>
                        </div>

                        <div class="event-organizer">üë§ Hosted by ${escapeHtml(event.event_organizer)}</div>

                        <div class="event-dates">
                            <div><strong>üìÖ Start:</strong> ${startDate} at ${startTime}</div>
                            <div><strong>üìÖ End:</strong> ${endDate} at ${endTime}</div>
                        </div>

                        ${event.description ? `<div class="event-description">${escapeHtml(event.description)}</div>` : ''}

                    </div>
                </div>
            `;
        }


        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
        }

        function formatTime(timeStr) {
            if (!timeStr) return 'N/A';
            return timeStr;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>

