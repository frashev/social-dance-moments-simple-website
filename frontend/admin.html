<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Dance Workshop Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        nav { background: #2c3e50; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        nav h1 { font-size: 24px; }
        nav button { background: #e74c3c; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        nav button:first-of-type { background: linear-gradient(135deg, #27ae60 0%, #229954 100%); box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3); transition: all 0.3s ease; }
        nav button:first-of-type:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(39, 174, 96, 0.5); }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 12px 24px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
        .tab-btn:nth-child(1) { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3); }
        .tab-btn:nth-child(1):hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(52, 152, 219, 0.5); }
        .tab-btn:nth-child(2) { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3); }
        .tab-btn:nth-child(2):hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(231, 76, 60, 0.5); }
        .tab-btn:nth-child(3) { background: linear-gradient(135deg, #f39c12 0%, #d68910 100%); color: white; box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3); }
        .tab-btn:nth-child(3):hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(243, 156, 18, 0.5); }
        .tab-btn:nth-child(4) { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); color: white; box-shadow: 0 4px 15px rgba(155, 89, 182, 0.3); }
        .tab-btn:nth-child(4):hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(155, 89, 182, 0.5); }
        .tab-btn.active { background: #667eea; color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stat-card h3 { color: #667eea; margin-bottom: 10px; }
        .stat-card .value { font-size: 32px; font-weight: bold; color: #2c3e50; }
        form { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px; display: block; }
        form.hidden { display: none !important; }
        form h2 { color: #2c3e50; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: 600; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        textarea { resize: vertical; min-height: 100px; }
        button { padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; }
        button:hover { background: #764ba2; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        th { background: #667eea; color: white; padding: 15px; text-align: left; font-weight: 600; }
        td { padding: 15px; border-bottom: 1px solid #ecf0f1; }
        tr:hover { background: #f9f9f9; }

        /* Mobile responsive table */
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column !important;
            }

            .tab-btn {
                width: 100% !important;
            }

            table, thead, tbody, th, td, tr {
                display: block;
                width: 100%;
            }
            thead {
                display: none;
            }
            tr {
                margin-bottom: 20px;
                border: 1px solid #ddd;
                border-radius: 8px;
                overflow: hidden;
                background: white;
            }
            td {
                padding: 12px 15px;
                text-align: right;
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding-left: 50%;
            }
            td:last-child {
                border-bottom: none;
            }
            td:before {
                content: attr(data-label);
                position: absolute;
                left: 15px;
                font-weight: 600;
                color: #667eea;
                text-align: left;
            }
            .action-btn {
                padding: 6px 12px;
                margin-right: 3px;
                margin-bottom: 5px;
                font-size: 11px;
                display: inline-block;
            }
        }
        .action-btn { padding: 8px 16px; margin-right: 5px; font-size: 12px; }
        .delete-btn { background: #e74c3c; }
        .edit-btn { background: #3498db; }
        .success { color: #27ae60; }
        .error { color: #e74c3c; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        #locationMap { height: 500px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .location-info { background: #e8f4f8; padding: 12px; border-radius: 5px; border-left: 4px solid #3498db; margin-bottom: 15px; }
        .location-list { max-height: 300px; overflow-y: auto; }
        .location-item { padding: 12px; background: #f9f9f9; border-left: 4px solid #3498db; margin-bottom: 8px; border-radius: 3px; display: flex; justify-content: space-between; align-items: center; }
        .location-item:hover { background: #f0f0f0; }
        /* Autocomplete styles */
        .autocomplete-container { position: relative; width: 100%; }
        .autocomplete-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        .autocomplete-input:focus { border-color: #667eea; box-shadow: 0 0 5px rgba(102, 126, 234, 0.2); outline: none; }
        .autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 5px 5px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; }
        .autocomplete-list.show { display: block; }
        .autocomplete-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .autocomplete-item:last-child { border-bottom: none; }
        .autocomplete-item:hover { background: #e8f4f8; }
        .autocomplete-item.highlighted { background: #667eea; color: white; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 600px; }
        .close { float: right; font-size: 28px; cursor: pointer; color: #999; }
    </style>
</head>
<body>
    <nav>
        <h1>üé™ Admin Dashboard</h1>
        <div style="display: flex; gap: 10px;">
            <button onclick="window.location.href='/home.html'">üè† Home</button>
            <button onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="container">
        <!-- Auth Check -->
        <div id="authMessage" style="display: none; padding: 20px; background: #fff3cd; border-radius: 5px; margin-bottom: 20px;">
            Please log in as admin to access this page.
        </div>

        <!-- Statistics -->
        <div class="stats" id="stats" style="display: none;">
            <div class="stat-card">
                <h3>üìç Welcome!</h3>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs" id="tabs" style="display: none;">
            <button class="tab-btn active" onclick="switchTab('workshops')">üìù Manage Workshops & Parties</button>
            <button class="tab-btn" onclick="switchTab('events')">üéâ Manage Events</button>
            <button class="tab-btn" onclick="switchTab('locations')">üìç Manage Locations</button>
            <button class="tab-btn" id="usersTabBtn" onclick="switchTab('users')" style="display: none;">üë• Manage Users</button>
        </div>

        <!-- Workshops Tab -->
        <div id="workshops-tab" class="tab-content active">
            <div style="margin-bottom: 20px;">
                <button type="button" id="createBtn" style="background: #27ae60; color: white; font-size: 16px; padding: 12px 24px; cursor: pointer; border: none; border-radius: 5px;">+ Create New Workshop or Party</button>
            </div>

            <form onsubmit="createWorkshop(event)" class="hidden" id="createForm">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>‚ú® Create New Workshop</h2>
                    <button type="button" onclick="toggleCreateForm()" style="background: #e74c3c; padding: 8px 16px;">‚úï Close</button>
                </div>
                <div id="formMessage" style="display: none; padding: 12px; border-radius: 5px; margin-bottom: 15px;"></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>City *</label>
                        <input type="text" id="city" placeholder="e.g., sofia" required>
                    </div>
                    <div class="form-group">
                        <label>Location *</label>
                        <div class="autocomplete-container">
                            <input type="text" id="location" class="autocomplete-input" placeholder="Start typing to see suggestions..." required autocomplete="off">
                            <div id="locationSuggestions" class="autocomplete-list"></div>
                        </div>
                        <small style="display: block; margin-top: 5px; color: #666;">üí° Type location name to see suggestions</small>
                    </div>
                    <div class="form-group">
                        <label>Date *</label>
                        <input type="date" id="date" required>
                    </div>
                    <div class="form-group">
                        <label>Start Time *</label>
                        <input type="time" id="start_time" required>
                    </div>
                    <div class="form-group">
                        <label>End Time *</label>
                        <input type="time" id="end_time" required>
                    </div>
                    <div class="form-group">
                        <label>Style *</label>
                        <select id="style" required>
                            <option value="">Select Style</option>
                            <option value="salsa">üíÉ Salsa</option>
                            <option value="bachata">üíï Bachata</option>
                            <option value="kizomba">üî• Kizomba</option>
                            <option value="zouk">‚ú® Zouk</option>
                            <option value="lets_party">üéâ Let's Party</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Difficulty</label>
                        <input type="text" id="difficulty" placeholder="e.g., Beginner, Intermediate, Advanced">
                    </div>
                </div>
                <div class="form-group">
                    <label>Instructor Name</label>
                    <input type="text" id="instructor_name" placeholder="e.g., Juan Martinez">
                </div>
                <div class="form-group">
                    <label>Cards (Dance Card Types)</label>
                    <select id="cards">
                        <option value="">-- None --</option>
                        <option value="Multisport">üî¥ Multisport</option>
                        <option value="Coolfit">üîµ Coolfit</option>
                        <option value="Multisport, Coolfit">üî¥üîµ Both (Multisport & Coolfit)</option>
                    </select>
                    <small style="color: #666; display: block; margin-top: 3px;">Optional: Select which dance cards are accepted</small>
                </div>
                <div class="form-group">
                    <label>Facebook URL</label>
                    <input type="url" id="facebook_url" placeholder="e.g., https://www.facebook.com/workshop-page">
                    <small style="color: #666; display: block; margin-top: 3px;">Optional: Link to workshop Facebook page or event</small>
                </div>
                <div class="form-group">
                    <label>Recurrence</label>
                    <select id="recurrence" required>
                        <option value="single">üìÖ Single Event</option>
                        <option value="weekly">üîÑ Each Week</option>
                    </select>
                    <small style="color: #666; display: block; margin-top: 3px;">Select if this is a one-time or weekly recurring event</small>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="description" placeholder="Describe the workshop..."></textarea>
                </div>
                <button type="submit" id="submitBtn" style="background: #27ae60; width: 100%; font-size: 16px;">Create Workshop</button>
            </form>


            <table>
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>City</th>
                        <th>Location</th>
                        <th>Date & Time</th>
                        <th>Recurrence</th>
                        <th>Style</th>
                        <th>Instructor</th>
                        <th>Cards</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="workshopsList">
                    <tr><td colspan="6">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Participants Tab -->
        <div id="participants-tab" class="tab-content">
            <div class="form-group" style="margin-bottom: 20px;">
                <label>Select Workshop</label>
                <select id="workshopSelect" onchange="loadParticipants()">
                    <option value="">Loading workshops...</option>
                </select>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Registered</th>
                        <th>Attended</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="participantsList">
                    <tr><td colspan="4">Select a workshop to view participants</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Locations Tab -->
        <div id="locations-tab" class="tab-content">
            <h2>üìç Manage Predefined Locations</h2>

            <div class="location-info">
                <strong>üí° How to use:</strong> Click on the map to place a pin, then fill in the location details below.
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <h3>üó∫Ô∏è Location Map</h3>
                    <div id="locationMap"></div>
                    <p style="font-size: 12px; color: #666; margin-top: 8px;">
                        Selected: <span id="selectedCoords" style="font-weight: bold;">Click on map to select location</span>
                    </p>
                </div>

                <div>
                    <h3>‚ûï Add New Location</h3>
                    <form id="locationForm" onsubmit="saveLocation(event)" style="padding: 15px; background: #f9f9f9; border-radius: 5px;">
                        <div class="form-group">
                            <label>City *</label>
                            <input type="text" id="locCity" placeholder="e.g., sofia" required onkeypress="handleCityKeyPress(event)">
                            <small style="color: #666; display: block; margin-top: 3px;">üí° Press Enter to go to city on map</small>
                        </div>
                        <div class="form-group">
                            <label>Location Name *</label>
                            <input type="text" id="locName" placeholder="e.g., Central Park" required>
                        </div>
                        <div class="form-group">
                            <label>Latitude *</label>
                            <input type="number" id="locLat" step="0.000001" readonly placeholder="Auto-filled">
                        </div>
                        <div class="form-group">
                            <label>Longitude *</label>
                            <input type="number" id="locLon" step="0.000001" readonly placeholder="Auto-filled">
                        </div>
                        <button type="submit" style="background: #27ae60; width: 100%;">üíæ Save Location</button>
                    </form>
                    <div id="locationMessage" style="display: none; margin-top: 10px; padding: 10px; border-radius: 5px;"></div>
                </div>
            </div>

            <h3>üìå Saved Locations</h3>
            <div class="location-list" id="locationsList">
                <p>Loading locations...</p>
            </div>
        </div>

        <!-- Events Tab -->
        <div id="events-tab" class="tab-content">
            <div style="margin-bottom: 20px;">
                <button type="button" id="createEventBtn" style="background: #e74c3c; color: white; font-size: 16px; padding: 12px 24px; cursor: pointer; border: none; border-radius: 5px; font-weight: 600; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(231, 76, 60, 0.5)'" onmouseout="this.style.transform='none'; this.style.boxShadow='0 4px 15px rgba(231, 76, 60, 0.3)'">üéâ Create New Event</button>
            </div>

            <form id="createEventForm" class="hidden" enctype="multipart/form-data">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>üéâ Create New Event</h2>
                    <button type="button" onclick="toggleCreateEventForm()" style="background: #e74c3c; padding: 8px 16px;">‚úï Close</button>
                </div>
                <div id="eventFormMessage" style="display: none; padding: 12px; border-radius: 5px; margin-bottom: 15px;"></div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Event Title *</label>
                        <input type="text" id="eventTitle" placeholder="e.g., Latin Festival 2026" required>
                    </div>
                    <div class="form-group">
                        <label>Event Organizer *</label>
                        <input type="text" id="eventOrganizer" placeholder="e.g., Sofia Dance Academy" required>
                    </div>
                    <div class="form-group">
                        <label>City *</label>
                        <input type="text" id="eventCity" placeholder="e.g., Sofia" required>
                    </div>
                    <div class="form-group">
                        <label>Location *</label>
                        <div class="autocomplete-container">
                            <input type="text" id="eventLocation" class="autocomplete-input" placeholder="Start typing to see suggestions..." required autocomplete="off">
                            <div id="eventLocationSuggestions" class="autocomplete-list"></div>
                        </div>
                        <small style="display: block; margin-top: 5px; color: #666;">üí° Type location name to see suggestions</small>
                    </div>
                    <div class="form-group">
                        <label>Start Date *</label>
                        <input type="date" id="eventStartDate" required>
                    </div>
                    <div class="form-group">
                        <label>Start Time *</label>
                        <input type="time" id="eventStartTime" required>
                    </div>
                    <div class="form-group">
                        <label>End Date *</label>
                        <input type="date" id="eventEndDate" required>
                    </div>
                    <div class="form-group">
                        <label>End Time *</label>
                        <input type="time" id="eventEndTime" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Event Photo</label>
                    <input type="file" id="eventPhoto" accept="image/*">
                    <small style="color: #666; display: block; margin-top: 3px;">Optional: Upload a photo for your event</small>
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea id="eventDescription" placeholder="Describe the event..."></textarea>
                </div>

                <div class="form-group">
                    <label>Facebook URL</label>
                    <input type="url" id="eventFacebookUrl" placeholder="e.g., https://www.facebook.com/event-page">
                    <small style="color: #666; display: block; margin-top: 3px;">Optional: Link to event Facebook page</small>
                </div>

                <button type="submit" id="submitEventBtn" style="background: #e74c3c; width: 100%; font-size: 16px;">üéâ Create Event</button>
            </form>

            <table>
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Organizer</th>
                        <th>Location</th>
                        <th>Start Date & Time</th>
                        <th>End Date & Time</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="eventsList">
                    <tr><td colspan="6">Loading events...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Users Tab (Super Admin Only) -->
        <div id="users-tab" class="tab-content">
            <h2>üë• Manage Users</h2>
            <p style="color: #666; margin-bottom: 20px;">As a super admin, you can toggle user admin status below.</p>

            <table>
                <thead>
                    <tr>
                        <th>User ID</th>
                        <th>Username</th>
                        <th>Admin Status</th>
                        <th>Super Admin</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersList">
                    <tr><td colspan="5">Loading users...</td></tr>
                </tbody>
            </table>
        </div>

    </div>

    <script>
        let token = sessionStorage.getItem('access_token');
        const userId = sessionStorage.getItem('user_id');
        const isAdminRaw = sessionStorage.getItem('is_admin');
        const isSuperAdminRaw = sessionStorage.getItem('is_super_admin');

        // Handle both string '0'/'1' and boolean true/false from API
        const isAdmin = isAdminRaw === 'true' || isAdminRaw === '1' || isAdminRaw === true;
        const isSuperAdmin = isSuperAdminRaw === 'true' || isSuperAdminRaw === '1' || isSuperAdminRaw === true;

        console.log('üîê Auth check:', { token: !!token, userId, isAdmin, isSuperAdmin });
        console.log('üì¶ sessionStorage:', { is_admin: isAdminRaw, is_super_admin: isSuperAdminRaw });

        // Refresh token automatically
        async function refreshTokenIfNeeded() {
            if (!token) return;

            try {
                const formData = new FormData();
                formData.append('token', token);

                const res = await fetch('/refresh', { method: 'POST', body: formData });
                if (res.ok) {
                    const data = await res.json();
                    if (data.access_token) {
                        token = data.access_token;
                        sessionStorage.setItem('access_token', token);
                        console.log('‚úÖ Token refreshed');
                    }
                }
            } catch (err) {
                console.error('Token refresh failed:', err);
            }
        }

        // Check token every 5 minutes
        setInterval(refreshTokenIfNeeded, 5 * 60 * 1000);

        // Check if user is admin on page load
        if (!token || !userId || !isAdmin) {
            document.getElementById('authMessage').style.display = 'block';
            document.getElementById('stats').style.display = 'none';
            document.getElementById('tabs').style.display = 'none';
        } else {
            document.getElementById('authMessage').style.display = 'none';
            document.getElementById('stats').style.display = 'grid';
            document.getElementById('tabs').style.display = 'flex';

            // Show users tab only for super_admins
            if (isSuperAdmin) {
                document.getElementById('usersTabBtn').style.display = 'inline-block';
                console.log('üëë Super admin detected - showing user management tab');
            }

            loadStats();
            loadWorkshops();
            loadWorkshopSelect();

            // Load users if super admin
            if (isSuperAdmin) {
                loadUsers();
            }
        }

        // Add event listener for create button
        document.getElementById('createBtn')?.addEventListener('click', function() {
            const form = document.getElementById('createForm');
            const btn = this;

            console.log('üîò Button clicked! Form hidden:', form.classList.contains('hidden'));

            form.classList.remove('hidden');
            btn.style.display = 'none';

            // Load predefined locations for autocomplete when form opens
            loadLocationsForAutocomplete();

            // Scroll form into view
            setTimeout(() => {
                form.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        });

        // Add event listener for start_time to auto-calculate end_time (1 hour duration)
        document.getElementById('start_time')?.addEventListener('change', function() {
            const startTime = this.value;
            if (startTime) {
                // Parse start time (HH:MM format)
                const [hours, minutes] = startTime.split(':').map(Number);
                // Add 1 hour
                let endHours = hours + 1;
                let endMinutes = minutes;
                // Handle day overflow
                if (endHours >= 24) {
                    endHours = endHours % 24;
                }
                // Format as HH:MM
                const endTimeValue = `${String(endHours).padStart(2, '0')}:${String(endMinutes).padStart(2, '0')}`;
                document.getElementById('end_time').value = endTimeValue;
            }
        });

        // Add event listener for workshop location autocomplete
        document.getElementById('location')?.addEventListener('input', function(e) {
            filterLocationSuggestions(e.target.value);
        });

        document.getElementById('location')?.addEventListener('blur', function() {
            setTimeout(() => {
                document.getElementById('locationSuggestions')?.classList.remove('show');
            }, 200);
        });



        function toggleCreateForm() {
            const form = document.getElementById('createForm');
            const btn = document.getElementById('createBtn');

            console.log('üîò Toggle clicked! Form hidden:', form.classList.contains('hidden'));

            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                btn.style.display = 'none';
            } else {
                form.classList.add('hidden');
                btn.style.display = 'block';
                form.reset();
                document.getElementById('formMessage').style.display = 'none';

                // Reset form title and button
                delete form.dataset.workshopId;
                document.querySelector('h2').textContent = '‚ú® Create New Workshop or Party';
                document.getElementById('submitBtn').textContent = 'Create Workshop';
            }
        }

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');

            // Initialize map if locations tab is clicked
            if (tabName === 'locations') {
                setTimeout(initLocationMap, 300);
                loadPredefinedLocations();
            }

            // Load events if events tab is clicked
            if (tabName === 'events') {
                loadEvents();
            }

            // Load users if users tab is clicked
            if (tabName === 'users') {
                loadUsers();
            }
        }

        // Location Management Functions
        let locationMap = null;
        let selectedLat = null;
        let selectedLon = null;
        let locationMarker = null;

        function initLocationMap() {
            if (locationMap) return; // Already initialized

            console.log('üó∫Ô∏è Initializing location map...');
            locationMap = L.map('locationMap').setView([40.7128, -74.0060], 13); // Default to NYC

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(locationMap);

            // Click handler to place marker
            locationMap.on('click', function(e) {
                selectedLat = e.latlng.lat;
                selectedLon = e.latlng.lng;

                // Update form fields
                document.getElementById('locLat').value = selectedLat.toFixed(6);
                document.getElementById('locLon').value = selectedLon.toFixed(6);

                // Update or create marker
                if (locationMarker) {
                    locationMarker.setLatLng([selectedLat, selectedLon]);
                } else {
                    locationMarker = L.marker([selectedLat, selectedLon], {
                        icon: L.icon({
                            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                            iconSize: [25, 41],
                            shadowSize: [41, 41],
                            iconAnchor: [12, 41],
                            shadowAnchor: [12, 41],
                            popupAnchor: [1, -34]
                        })
                    }).addTo(locationMap);
                }

                document.getElementById('selectedCoords').textContent =
                    `üìç ${selectedLat.toFixed(4)}, ${selectedLon.toFixed(4)}`;
                console.log('üìç Location selected:', selectedLat, selectedLon);
            });
        }

        async function saveLocation(e) {
            e.preventDefault();

            if (!selectedLat || !selectedLon) {
                showLocationMessage('‚ùå Please click on the map to select a location', 'error');
                return;
            }

            const city = document.getElementById('locCity').value.trim();
            const locName = document.getElementById('locName').value.trim();

            if (!city || !locName) {
                showLocationMessage('‚ùå Please fill in all required fields', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('city', city);
            formData.append('location_name', locName);
            formData.append('lat', selectedLat);
            formData.append('lon', selectedLon);

            try {
                console.log('üì§ Saving location:', { city, locName, selectedLat, selectedLon });
                const res = await fetch(`/admin/locations?token=${token}`, { method: 'POST', body: formData });
                const data = await res.json();

                if (res.ok) {
                    showLocationMessage('‚úÖ Location saved successfully!', 'success');
                    document.getElementById('locationForm').reset();
                    document.getElementById('locLat').value = '';
                    document.getElementById('locLon').value = '';
                    document.getElementById('selectedCoords').textContent = 'Click on map to select location';
                    selectedLat = null;
                    selectedLon = null;
                    if (locationMarker) {
                        locationMap.removeLayer(locationMarker);
                        locationMarker = null;
                    }
                    loadPredefinedLocations();
                } else {
                    showLocationMessage('‚ùå Error: ' + (data.detail || data.msg), 'error');
                }
            } catch (err) {
                console.error('‚ùå Error saving location:', err);
                showLocationMessage('‚ùå Error: ' + err.message, 'error');
            }
        }

        async function loadPredefinedLocations() {
            try {
                const res = await fetch(`/admin/locations?token=${token}`);
                const data = await res.json();

                const listDiv = document.getElementById('locationsList');
                if (!data.locations || data.locations.length === 0) {
                    listDiv.innerHTML = '<p style="color: #999;">No locations saved yet.</p>';
                    return;
                }

                listDiv.innerHTML = data.locations.map(loc => `
                    <div class="location-item">
                        <div>
                            <strong>${loc.location_name}</strong><br>
                            <small>üìç ${loc.city} ‚Ä¢ ${loc.lat.toFixed(4)}, ${loc.lon.toFixed(4)}</small>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('‚ùå Error loading locations:', err);
                document.getElementById('locationsList').innerHTML = '<p>Error loading locations</p>';
            }
        }

        async function deleteLocation(locId) {
            if (!confirm('Are you sure you want to delete this location?')) return;

            try {
                const res = await fetch(`/admin/locations/${locId}?token=${token}`, { method: 'DELETE' });
                const data = await res.json();

                if (res.ok) {
                    showLocationMessage('‚úÖ Location deleted!', 'success');
                    loadPredefinedLocations();
                } else {
                    showLocationMessage('‚ùå Error: ' + (data.detail || data.msg), 'error');
                }
            } catch (err) {
                showLocationMessage('‚ùå Error: ' + err.message, 'error');
            }
        }

        function showLocationMessage(msg, type) {
            const msgDiv = document.getElementById('locationMessage');
            msgDiv.textContent = msg;
            msgDiv.style.background = type === 'success' ? '#d4edda' : '#f8d7da';
            msgDiv.style.color = type === 'success' ? '#155724' : '#721c24';
            msgDiv.style.display = 'block';

            if (type === 'success') {
                setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);
            }
        }

        async function loadStats() {
            try {
                const res = await fetch(`/admin/stats?token=${token}`);
                const data = await res.json();
                const totalElement = document.getElementById('totalWorkshops');
                if (totalElement) {
                    totalElement.textContent = data.total_workshops;
                } else {
                    console.log('üìä Stats:', data);
                }
            } catch (err) {
                console.error('Error loading stats:', err);
            }
        }

        function getDayOfWeek(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[date.getDay()];
        }

        function getDayIndex(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            let dayIndex = date.getDay();
            // Convert to Monday = 0, Sunday = 6
            return dayIndex === 0 ? 6 : dayIndex - 1;
        }

        async function loadWorkshops() {
            try {
                const res = await fetch(`/admin/workshops?token=${token}`);
                const data = await res.json();
                const tbody = document.getElementById('workshopsList');

                if (data.workshops.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10">No workshops yet</td></tr>';
                } else {
                    // Sort workshops by day of week (Monday to Sunday) then by time
                    const sortedWorkshops = data.workshops.sort((a, b) => {
                        const dayA = getDayIndex(a.date);
                        const dayB = getDayIndex(b.date);

                        if (dayA !== dayB) {
                            return dayA - dayB;
                        }
                        // Same day, sort by time
                        return (a.start_time || a.time || '').localeCompare(b.start_time || b.time || '');
                    });

                    const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                    let html = '';
                    let currentDay = null;

                    sortedWorkshops.forEach(w => {
                        const day = getDayIndex(w.date);
                        const dayName = dayNames[day];

                        // Add delimiter row when day changes
                        if (currentDay !== day) {
                            if (currentDay !== null) {
                                html += '<tr style="height: 8px; background: linear-gradient(90deg, transparent, #667eea, transparent); border: none;"><td colspan="10"></td></tr>';
                            }
                            html += `<tr style="background: #667eea; color: white; font-weight: bold; height: 40px;"><td colspan="10" style="text-align: center; padding: 10px; font-size: 16px;">üìÖ ${dayName}</td></tr>`;
                            currentDay = day;
                        }

                        // Display time range (start - end) with fallback to old 'time' field
                        const startTime = w.start_time || w.time || '';
                        const endTime = w.end_time || '';
                        const timeRange = endTime ? `${startTime} - ${endTime}` : startTime;

                        html += `
                            <tr>
                                <td data-label="Description">${w.description || '-'}</td>
                                <td data-label="City">${w.city}</td>
                                <td data-label="Location">${w.location}</td>
                                <td data-label="Date & Time">${getDayOfWeek(w.date)} ${w.date} ${timeRange}</td>
                                <td data-label="Recurrence">${w.recurrence === 'weekly' ? 'üîÑ Weekly' : 'üìÖ Single'}</td>
                                <td data-label="Style"><strong>${w.style}</strong></td>
                                <td data-label="Instructor">${w.instructor_name || '-'}</td>
                                <td data-label="Cards">${w.cards || '-'}</td>
                                <td data-label="Actions">
                                    <button class="action-btn edit-btn" onclick="editWorkshop(${w.id})">Edit</button>
                                    <button class="action-btn" style="background: #f39c12;" onclick="duplicateWorkshop(${w.id})">Duplicate</button>
                                    <button class="action-btn delete-btn" onclick="deleteWorkshop(${w.id})">Delete</button>
                                </td>
                            </tr>
                        `;
                    });

                    tbody.innerHTML = html;
                }
            } catch (err) {
                console.error('Error loading workshops:', err);
            }
        }

        async function loadWorkshopSelect() {
            try {
                const res = await fetch(`/admin/workshops?token=${token}`);
                const data = await res.json();
                const select = document.getElementById('workshopSelect');
                select.innerHTML = '<option value="">Select a workshop...</option>' +
                    data.workshops.map(w => `<option value="${w.id}">${w.city} - ${w.location}</option>`).join('');
            } catch (err) {
                console.error('Error loading workshop select:', err);
            }
        }

        async function createWorkshop(e) {
            e.preventDefault();

            console.log('üìù Form submitted!');

            // Show loading state
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '‚è≥ Creating...';
            submitBtn.disabled = true;

            const messageDiv = document.getElementById('formMessage');
            messageDiv.style.display = 'none';

            // Check if we're editing or creating
            const form = document.getElementById('createForm');
            const workshopId = form.dataset.workshopId;
            const isEditing = !!workshopId;

            // Collect form data
            const formData = new FormData();
            const city = document.getElementById('city').value.trim();
            const location = document.getElementById('location').value.trim();
            const date = document.getElementById('date').value;
            const start_time = document.getElementById('start_time').value;
            const end_time = document.getElementById('end_time').value;
            const style = document.getElementById('style').value;

            console.log('üìù Form data:', { city, location, date, start_time, end_time, style, isEditing });

            formData.append('city', city);
            formData.append('location', location);
            formData.append('date', date);
            formData.append('start_time', start_time);
            formData.append('end_time', end_time);
            formData.append('style', style);
            formData.append('difficulty', document.getElementById('difficulty').value);
            formData.append('instructor_name', document.getElementById('instructor_name').value.trim());
            formData.append('description', document.getElementById('description').value.trim());
            formData.append('cards', document.getElementById('cards').value || '');
            formData.append('facebook_url', document.getElementById('facebook_url').value.trim() || '');
            formData.append('recurrence', document.getElementById('recurrence').value);

            // Add coordinates if available from selected location
            const latField = document.getElementById('location_lat');
            const lonField = document.getElementById('location_lon');
            if (latField && latField.value) formData.append('lat', latField.value);
            if (lonField && lonField.value) formData.append('lon', lonField.value);

            try {
                const url = isEditing ? `/admin/workshops/${workshopId}?token=${token}` : `/admin/workshops?token=${token}`;
                const method = isEditing ? 'PUT' : 'POST';

                console.log(`üì§ Sending ${method} to ${url}...`);
                const res = await fetch(url, { method: method, body: formData });
                const data = await res.json();

                console.log('üì• Response:', res.status, data);

                if (res.ok) {
                    // Success!
                    messageDiv.style.background = '#d4edda';
                    messageDiv.style.color = '#155724';
                    messageDiv.textContent = isEditing ? '‚úÖ Workshop updated successfully!' : '‚úÖ Workshop created successfully!';
                    messageDiv.style.display = 'block';

                    // Reset form
                    document.getElementById('createForm').reset();
                    delete form.dataset.workshopId;

                    // Reload workshops and close form after 2 seconds
                    setTimeout(() => {
                        loadWorkshops();
                        loadWorkshopSelect();
                        toggleCreateForm();

                        // Reset form title and button
                        document.querySelector('h2').textContent = '‚ú® Create New Workshop or Party';
                        document.getElementById('submitBtn').textContent = 'Create Workshop';
                    }, 1500);
                } else {
                    // Error from server
                    messageDiv.style.background = '#f8d7da';
                    messageDiv.style.color = '#721c24';
                    messageDiv.textContent = '‚ùå Error: ' + (data.detail || data.msg || 'Failed to save workshop');
                    messageDiv.style.display = 'block';
                }
            } catch (err) {
                console.error('‚ùå Workshop error:', err);
                messageDiv.style.background = '#f8d7da';
                messageDiv.style.color = '#721c24';
                messageDiv.textContent = '‚ùå Error: ' + err.message;
                messageDiv.style.display = 'block';
            } finally {
                // Reset button
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        async function editWorkshop(workshopId) {
            try {
                console.log('‚úèÔ∏è Starting edit for workshop ID:', workshopId);

                // Fetch workshop data
                const res = await fetch(`/admin/workshops?token=${token}`);
                console.log('üì• API Response status:', res.status);

                if (!res.ok) {
                    throw new Error(`API error: ${res.status} ${res.statusText}`);
                }

                const data = await res.json();
                console.log('üì¶ Fetched workshops count:', data.workshops?.length);
                console.log('üìä All workshops:', data.workshops);

                const workshop = data.workshops.find(w => w.id === workshopId);
                console.log('üéØ Found workshop:', workshop);

                if (!workshop) {
                    alert('Workshop not found');
                    return;
                }

                console.log('üìù Editing workshop:', workshop);

                // Show form and change button text FIRST (so elements exist in DOM)
                const form = document.getElementById('createForm');
                form.classList.remove('hidden');
                document.getElementById('createBtn').style.display = 'none';
                document.querySelector('h2').textContent = '‚úèÔ∏è Edit Workshop';
                document.getElementById('submitBtn').textContent = 'Update Workshop';

                // NOW populate the form with existing data (elements are in DOM)
                console.log('üìù Populating form fields...');
                document.getElementById('city').value = workshop.city || '';
                document.getElementById('location').value = workshop.location || '';
                document.getElementById('date').value = workshop.date || '';
                document.getElementById('start_time').value = workshop.start_time || workshop.time || '';
                document.getElementById('end_time').value = workshop.end_time || '';
                document.getElementById('style').value = workshop.style || '';
                document.getElementById('difficulty').value = workshop.difficulty || '';
                document.getElementById('instructor_name').value = workshop.instructor_name || '';
                document.getElementById('cards').value = workshop.cards || '';
                document.getElementById('facebook_url').value = workshop.facebook_url || '';
                document.getElementById('recurrence').value = workshop.recurrence || 'single';
                document.getElementById('description').value = workshop.description || '';
                console.log('‚úÖ Form fields populated');

                // Store workshop ID for update
                form.dataset.workshopId = workshopId;

                // Scroll to form
                form.scrollIntoView({ behavior: 'smooth', block: 'start' });

                // Load locations for autocomplete
                loadLocationsForAutocomplete();
                console.log('‚ú® Edit form ready');
            } catch (err) {
                console.error('‚ùå Error loading workshop:', err);
                alert('Error loading workshop data: ' + err.message);
            }
        }

        async function duplicateWorkshop(workshopId) {
            try {
                console.log('üîÑ Starting duplicate for workshop ID:', workshopId);

                // Fetch workshop data
                const res = await fetch(`/admin/workshops?token=${token}`);
                console.log('üì• API Response status:', res.status);

                if (!res.ok) {
                    throw new Error(`API error: ${res.status} ${res.statusText}`);
                }

                const data = await res.json();
                console.log('üì¶ Fetched workshops count:', data.workshops?.length);
                console.log('üìä All workshops:', data.workshops);

                const workshop = data.workshops.find(w => w.id === workshopId);
                console.log('üéØ Found workshop:', workshop);

                if (!workshop) {
                    alert('Workshop not found');
                    return;
                }

                console.log('üìã Duplicating workshop:', workshop);

                // Show form and change button text FIRST (so elements exist in DOM)
                const form = document.getElementById('createForm');
                form.classList.remove('hidden');
                document.getElementById('createBtn').style.display = 'none';
                document.querySelector('h2').textContent = 'üìã Duplicate Workshop';
                document.getElementById('submitBtn').textContent = 'Create Duplicate';

                // NOW populate the form with existing data (elements are in DOM)
                console.log('üìù Populating form fields...');
                document.getElementById('city').value = workshop.city || '';
                document.getElementById('location').value = workshop.location || '';
                document.getElementById('date').value = workshop.date || '';
                document.getElementById('start_time').value = workshop.start_time || workshop.time || '';
                document.getElementById('end_time').value = workshop.end_time || '';
                document.getElementById('style').value = workshop.style || '';
                document.getElementById('difficulty').value = workshop.difficulty || '';
                document.getElementById('instructor_name').value = workshop.instructor_name || '';
                document.getElementById('cards').value = workshop.cards || '';
                document.getElementById('facebook_url').value = workshop.facebook_url || '';
                document.getElementById('recurrence').value = workshop.recurrence || 'single';
                document.getElementById('description').value = workshop.description || '';
                console.log('‚úÖ Form fields populated');

                // Clear workshop ID (so it will create new, not update)
                const formData = document.getElementById('createForm');
                delete formData.dataset.workshopId;

                // Scroll to form
                form.scrollIntoView({ behavior: 'smooth', block: 'start' });

                // Load locations for autocomplete
                loadLocationsForAutocomplete();

                // Show info message
                const messageDiv = document.getElementById('formMessage');
                messageDiv.style.background = '#d4edda';
                messageDiv.style.color = '#155724';
                messageDiv.textContent = '‚úÖ Workshop data loaded. Modify as needed and click "Create Duplicate"';
                messageDiv.style.display = 'block';
                console.log('‚ú® Duplicate form ready');
            } catch (err) {
                console.error('‚ùå Error duplicating workshop:', err);
                alert('Error loading workshop data: ' + err.message);
            }
        }

        async function deleteWorkshop(workshopId) {
            if (!confirm('Delete this workshop? This will also delete all registrations.')) return;

            try {
                const res = await fetch(`/admin/workshops/${workshopId}?token=${token}`, { method: 'DELETE' });
                const data = await res.json();
                alert(data.msg);
                loadWorkshops();
                loadWorkshopSelect();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function loadParticipants() {
            const workshopId = document.getElementById('workshopSelect').value;
            if (!workshopId) {
                document.getElementById('participantsList').innerHTML = '<tr><td colspan="4">Select a workshop</td></tr>';
                return;
            }

            try {
                const res = await fetch(`/admin/workshops/${workshopId}/participants?token=${token}`);
                const data = await res.json();
                const tbody = document.getElementById('participantsList');

                if (data.participants.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4">No participants yet</td></tr>';
                } else {
                    tbody.innerHTML = data.participants.map(p => `
                        <tr>
                            <td data-label="User">${p.username}</td>
                            <td data-label="Registered">${new Date(p.registered_at).toLocaleDateString()}</td>
                            <td data-label="Attended">${p.attended ? '‚úÖ Yes' : '‚ùå No'}</td>
                            <td data-label="Actions">
                                <button class="action-btn edit-btn" onclick="toggleAttended(${p.id}, ${p.attended})">
                                    Mark ${p.attended ? 'Absent' : 'Attended'}
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (err) {
                console.error('Error loading participants:', err);
            }
        }

        function logout() {
            sessionStorage.removeItem('access_token');
            sessionStorage.removeItem('user_id');
            sessionStorage.removeItem('is_admin');
            window.location.href = '/login.html';
        }

        // Store all locations for autocomplete
        let allLocations = [];

        async function loadLocationsForAutocomplete() {
            try {
                const res = await fetch(`/admin/locations?token=${token}`);
                const data = await res.json();
                allLocations = data.locations || [];
                console.log('‚úÖ Locations loaded for autocomplete:', allLocations.length);
            } catch (err) {
                console.error('Error loading locations:', err);
            }
        }

        function filterLocationSuggestions(query) {
            if (!query.trim()) {
                document.getElementById('locationSuggestions').classList.remove('show');
                return;
            }

            const filtered = allLocations.filter(loc =>
                loc.location_name.toLowerCase().includes(query.toLowerCase()) ||
                loc.city.toLowerCase().includes(query.toLowerCase())
            );

            const suggestionsDiv = document.getElementById('locationSuggestions');

            if (filtered.length === 0) {
                suggestionsDiv.innerHTML = '<div style="padding: 10px; color: #999;">No locations found</div>';
                suggestionsDiv.classList.add('show');
                return;
            }

            suggestionsDiv.innerHTML = filtered.map((loc, index) => `
                <div class="autocomplete-item" onclick="selectLocationSuggestion('${loc.location_name}', '${loc.city}', ${loc.lat}, ${loc.lon})" data-index="${index}">
                    <strong>${loc.location_name}</strong>
                    <small style="color: #666; display: block;">üìç ${loc.city} (${loc.lat.toFixed(2)}, ${loc.lon.toFixed(2)})</small>
                </div>
            `).join('');

            suggestionsDiv.classList.add('show');
        }

        function selectLocationSuggestion(name, city, lat, lon) {
            document.getElementById('location').value = name;
            document.getElementById('city').value = city;

            // Store coordinates in hidden fields for submission
            let latField = document.getElementById('location_lat');
            let lonField = document.getElementById('location_lon');

            if (!latField) {
                latField = document.createElement('input');
                latField.type = 'hidden';
                latField.id = 'location_lat';
                latField.name = 'lat';
                document.getElementById('createForm').appendChild(latField);
            }

            if (!lonField) {
                lonField = document.createElement('input');
                lonField.type = 'hidden';
                lonField.id = 'location_lon';
                lonField.name = 'lon';
                document.getElementById('createForm').appendChild(lonField);
            }

            latField.value = lat;
            lonField.value = lon;

            document.getElementById('locationSuggestions').classList.remove('show');
            console.log('‚úÖ Selected location:', name, 'in', city, 'with coordinates:', lat, lon);
        }

        function filterEventLocationSuggestions(query) {
            if (!query.trim()) {
                document.getElementById('eventLocationSuggestions').classList.remove('show');
                return;
            }

            const filtered = allLocations.filter(loc =>
                loc.location_name.toLowerCase().includes(query.toLowerCase()) ||
                loc.city.toLowerCase().includes(query.toLowerCase())
            );

            const suggestionsDiv = document.getElementById('eventLocationSuggestions');

            if (filtered.length === 0) {
                suggestionsDiv.innerHTML = '<div style="padding: 10px; color: #999;">No locations found</div>';
                suggestionsDiv.classList.add('show');
                return;
            }

            suggestionsDiv.innerHTML = filtered.map((loc, index) => `
                <div class="autocomplete-item" onclick="selectEventLocationSuggestion('${loc.location_name}', '${loc.city}', ${loc.lat}, ${loc.lon})" data-index="${index}">
                    <strong>${loc.location_name}</strong>
                    <small style="color: #666; display: block;">üìç ${loc.city} (${loc.lat.toFixed(2)}, ${loc.lon.toFixed(2)})</small>
                </div>
            `).join('');

            suggestionsDiv.classList.add('show');
        }

        function selectEventLocationSuggestion(name, city, lat, lon) {
            document.getElementById('eventLocation').value = name;
            document.getElementById('eventCity').value = city;

            // Store coordinates in hidden fields for submission
            let latField = document.getElementById('event_location_lat');
            let lonField = document.getElementById('event_location_lon');

            if (!latField) {
                latField = document.createElement('input');
                latField.type = 'hidden';
                latField.id = 'event_location_lat';
                latField.name = 'event_lat';
                document.getElementById('createEventForm').appendChild(latField);
            }

            if (!lonField) {
                lonField = document.createElement('input');
                lonField.type = 'hidden';
                lonField.id = 'event_location_lon';
                lonField.name = 'event_lon';
                document.getElementById('createEventForm').appendChild(lonField);
            }

            latField.value = lat;
            lonField.value = lon;

            document.getElementById('eventLocationSuggestions').classList.remove('show');
            console.log('‚úÖ Selected event location:', name, 'in', city, 'with coordinates:', lat, lon);
        }

        // Add event listener to location input
        document.addEventListener('DOMContentLoaded', function() {
            const locationInput = document.getElementById('location');
            if (locationInput) {
                locationInput.addEventListener('input', function(e) {
                    filterLocationSuggestions(e.target.value);
                });

                locationInput.addEventListener('focus', function() {
                    if (this.value) {
                        filterLocationSuggestions(this.value);
                    }
                });

                // Close suggestions when clicking outside
                document.addEventListener('click', function(e) {
                    if (!e.target.matches('.autocomplete-input')) {
                        document.getElementById('locationSuggestions').classList.remove('show');
                        document.getElementById('eventLocationSuggestions').classList.remove('show');
                    }
                });
            }

            // Add listener for event location input
            const eventLocationInput = document.getElementById('eventLocation');
            if (eventLocationInput) {
                eventLocationInput.addEventListener('input', function(e) {
                    filterEventLocationSuggestions(e.target.value);
                });

                eventLocationInput.addEventListener('focus', function() {
                    if (this.value) {
                        filterEventLocationSuggestions(this.value);
                    }
                });
            }
        });

        // Geocoding function to find city coordinates
        async function geocodeCity(cityName) {
            try {
                console.log('üîç Geocoding city:', cityName);
                const response = await fetch(`https://nominatim.openstreetmap.org/search?city=${encodeURIComponent(cityName)}&format=json&limit=1`);
                const results = await response.json();

                if (results.length === 0) {
                    showLocationMessage(`‚ùå City "${cityName}" not found on map`, 'error');
                    console.log('‚ùå No results for:', cityName);
                    return null;
                }

                const result = results[0];
                const lat = parseFloat(result.lat);
                const lon = parseFloat(result.lon);

                console.log('üìç Found city:', cityName, lat, lon);
                return { lat, lon, city: result.name || cityName };
            } catch (err) {
                console.error('‚ùå Geocoding error:', err);
                showLocationMessage('‚ùå Error looking up city', 'error');
                return null;
            }
        }

        // Handle Enter key in city input
        function handleCityKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const cityName = document.getElementById('locCity').value.trim();

                if (!cityName) {
                    showLocationMessage('‚ùå Please enter a city name', 'error');
                    return;
                }

                // Geocode and center map
                geocodeCity(cityName).then(result => {
                    if (result && locationMap) {
                        locationMap.setView([result.lat, result.lon], 13);
                        console.log('üó∫Ô∏è Map centered on:', result.city);
                        showLocationMessage(`‚úÖ Map centered on ${result.city}`, 'success');
                    }
                });
            }
        }

        // Event Management Functions

        // Add event listener for create event button
        document.getElementById('createEventBtn')?.addEventListener('click', function() {
            const form = document.getElementById('createEventForm');
            const btn = this;

            form.classList.remove('hidden');
            btn.style.display = 'none';

            // Load predefined locations for autocomplete when form opens
            loadLocationsForAutocomplete();

            // Scroll form into view
            setTimeout(() => {
                form.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        });

        // Add event listener for form submission
        document.getElementById('createEventForm')?.addEventListener('submit', function(e) {
            createEvent(e);
        });

        function toggleCreateEventForm() {
            const form = document.getElementById('createEventForm');
            const btn = document.getElementById('createEventBtn');
            const submitBtn = document.getElementById('submitEventBtn');

            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                btn.style.display = 'none';
            } else {
                form.classList.add('hidden');
                btn.style.display = 'block';
                form.reset();
                document.getElementById('eventFormMessage').style.display = 'none';
                // Clear photo preview
                const photoPreviewDiv = document.getElementById('eventPhotoPreview');
                if (photoPreviewDiv) photoPreviewDiv.style.display = 'none';
                // Reset photo input
                document.getElementById('eventPhoto').dataset.existingPhoto = '';
                // Reset to create mode
                submitBtn.dataset.mode = 'create';
                submitBtn.dataset.eventId = '';
                submitBtn.textContent = 'üéâ Create Event';
                document.querySelector('#createEventForm h2').textContent = 'üéâ Create New Event';
            }
        }

        async function createEvent(e) {
            e.preventDefault();
            console.log('üéâ createEvent called');

            const submitBtn = document.getElementById('submitEventBtn');
            const isEditMode = submitBtn.dataset.mode === 'edit';
            const eventId = submitBtn.dataset.eventId;

            const title = document.getElementById('eventTitle').value.trim();
            const organizer = document.getElementById('eventOrganizer').value.trim();
            const city = document.getElementById('eventCity').value.trim();
            const location = document.getElementById('eventLocation').value.trim();
            const startDate = document.getElementById('eventStartDate').value;
            const startTime = document.getElementById('eventStartTime').value;
            const endDate = document.getElementById('eventEndDate').value;
            const endTime = document.getElementById('eventEndTime').value;
            const description = document.getElementById('eventDescription').value.trim();
            const facebookUrl = document.getElementById('eventFacebookUrl').value.trim();
            const photoFile = document.getElementById('eventPhoto').files[0];

            console.log('üìã Form data:', { title, organizer, city, location, startDate, startTime, endDate, endTime });

            if (!title || !organizer || !city || !location || !startDate || !startTime || !endDate || !endTime) {
                console.warn('‚ö†Ô∏è Missing required fields');
                showEventMessage('‚ùå Please fill in all required fields', 'error');
                return false;
            }

            // Validate dates
            if (new Date(endDate + 'T' + endTime) <= new Date(startDate + 'T' + startTime)) {
                console.warn('‚ö†Ô∏è Invalid date range');
                showEventMessage('‚ùå End date/time must be after start date/time', 'error');
                return false;
            }

            const formData = new FormData();
            formData.append('title', title);
            formData.append('event_organizer', organizer);
            formData.append('city', city);
            formData.append('location', location);
            formData.append('start_date', startDate);
            formData.append('start_time', startTime);
            formData.append('end_date', endDate);
            formData.append('end_time', endTime);
            formData.append('description', description);
            formData.append('facebook_url', facebookUrl);

            // Read photo file fresh right here
            const photoFileForSubmission = document.getElementById('eventPhoto').files[0];

            if (photoFileForSubmission) {
                formData.append('photo', photoFileForSubmission);
            } else {
                // If no new photo file, check if there's an existing photo path to reuse
                const existingPhotoPath = document.getElementById('eventPhoto').dataset.existingPhoto;
                if (existingPhotoPath) {
                    formData.append('photo_path', existingPhotoPath);
                }
            }

            try {
                if (isEditMode) {
                    // UPDATE existing event
                    showEventMessage('‚è≥ Updating event...', 'info');
                    console.log(`üåê Sending PUT to /events/${eventId}`, { eventId, formDataEntries: Object.fromEntries(formData) });

                    const res = await fetch(`/events/${eventId}`, {
                        method: 'PUT',
                        body: formData
                    });

                    console.log('üì° Response received:', { status: res.status, ok: res.ok });
                    const data = await res.json();
                    console.log('üì¶ Response data:', data);

                    if (!res.ok) {
                        throw new Error(data.detail || 'Failed to update event');
                    }

                    showEventMessage(`‚úÖ ${data.msg}`, 'success');
                } else {
                    // CREATE new event
                    showEventMessage('‚è≥ Creating event...', 'info');
                    console.log(`üåê Sending POST to /events?admin_id=${userId}`, { userId, formDataEntries: Object.fromEntries(formData) });

                    const res = await fetch(`/events?admin_id=${userId}`, {
                        method: 'POST',
                        body: formData
                    });

                    console.log('üì° Response received:', { status: res.status, ok: res.ok });
                    const data = await res.json();
                    console.log('üì¶ Response data:', data);

                    if (!res.ok) {
                        throw new Error(data.detail || 'Failed to create event');
                    }

                    showEventMessage(`‚úÖ ${data.msg}`, 'success');
                }

                document.getElementById('createEventForm').reset();
                toggleCreateEventForm();
                loadEvents();
                // Reset form to create mode
                submitBtn.dataset.mode = 'create';
                submitBtn.dataset.eventId = '';
                submitBtn.textContent = 'üéâ Create Event';
                document.querySelector('#createEventForm h2').textContent = 'üéâ Create New Event';
            } catch (err) {
                console.error('‚ùå Error:', err);
                showEventMessage(`‚ùå Error: ${err.message}`, 'error');
            }

            return false;
        }

        async function loadEvents() {
            try {
                console.log('üéâ Loading events...');
                const res = await fetch('/events');
                const data = await res.json();

                if (!res.ok) {
                    if (res.status === 404) {
                        console.warn('‚ö†Ô∏è Events endpoint not found. Please restart the server.');
                        const tbody = document.getElementById('eventsList');
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #f39c12;">‚ö†Ô∏è Events feature requires server restart. Please refresh the page.</td></tr>';
                        return;
                    }
                    throw new Error(data.detail || 'Failed to load events');
                }

                const tbody = document.getElementById('eventsList');
                tbody.innerHTML = '';

                if (data.events.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #999;">No events yet</td></tr>';
                    return;
                }

                data.events.forEach(event => {
                    const startDateTime = `${event.start_date} ${event.start_time}`;
                    const endDateTime = `${event.end_date} ${event.end_time}`;
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td data-label="Title">${event.title}</td>
                        <td data-label="Organizer">${event.event_organizer}</td>
                        <td data-label="Location">${event.location}, ${event.city}</td>
                        <td data-label="Start">${startDateTime}</td>
                        <td data-label="End">${endDateTime}</td>
                        <td data-label="Actions">
                            <button class="action-btn edit-btn" onclick="editEvent(${event.id})">‚úèÔ∏è Edit</button>
                            <button class="action-btn" onclick="duplicateEvent(${event.id})" style="background: #f39c12;">üìã Duplicate</button>
                            <button class="action-btn delete-btn" onclick="deleteEvent(${event.id})">üóëÔ∏è Delete</button>
                        </td>
                    `;
                });
            } catch (err) {
                console.error('‚ùå Error loading events:', err);
                const tbody = document.getElementById('eventsList');
                tbody.innerHTML = '<tr><td colspan="6" style="color: red; text-align: center; padding: 20px;">‚ùå Error loading events. Please try again.</td></tr>';
            }
        }

        async function deleteEvent(eventId) {
            if (!confirm('üóëÔ∏è Are you sure you want to delete this event?')) {
                return;
            }

            try {
                const res = await fetch(`/events/${eventId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.detail || 'Failed to delete event');
                }

                showEventMessage(`‚úÖ Event deleted`, 'success');
                loadEvents();
            } catch (err) {
                console.error('‚ùå Error deleting event:', err);
                showEventMessage(`‚ùå Error: ${err.message}`, 'error');
            }
        }

        async function editEvent(eventId) {
            try {
                // Fetch event details
                const res = await fetch(`/events/${eventId}`);
                if (!res.ok) {
                    throw new Error('Failed to load event');
                }
                const data = await res.json();
                const event = data.event;

                // Populate form with event data
                document.getElementById('eventTitle').value = event.title || '';
                document.getElementById('eventOrganizer').value = event.event_organizer || '';
                document.getElementById('eventCity').value = event.city || '';
                document.getElementById('eventLocation').value = event.location || '';
                document.getElementById('eventStartDate').value = event.start_date || '';
                document.getElementById('eventStartTime').value = event.start_time || '';
                document.getElementById('eventEndDate').value = event.end_date || '';
                document.getElementById('eventEndTime').value = event.end_time || '';
                document.getElementById('eventDescription').value = event.description || '';
                document.getElementById('eventFacebookUrl').value = event.facebook_url || '';

                // Store lat/lon if available
                const latField = document.getElementById('event_location_lat');
                const lonField = document.getElementById('event_location_lon');
                if (latField) latField.value = event.lat || '';
                if (lonField) lonField.value = event.lon || '';

                // Handle photo preview
                const photoInput = document.getElementById('eventPhoto');
                const photoPreviewDiv = document.getElementById('eventPhotoPreview') || createPhotoPreviewDiv();

                if (event.photo_path) {
                    console.log('üì∑ Loading existing photo:', event.photo_path);
                    photoPreviewDiv.innerHTML = `
                        <div style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 5px; text-align: center;">
                            <p style="margin: 0 0 10px 0; color: #666; font-size: 12px;">üì∏ Current Photo:</p>
                            <img src="/${event.photo_path}" alt="Event Photo" style="max-width: 200px; max-height: 150px; border-radius: 3px; margin-bottom: 10px;">
                            <p style="margin: 10px 0; font-size: 12px; color: #999;">Upload a new photo to replace it</p>
                        </div>
                    `;
                    photoPreviewDiv.style.display = 'block';
                    // Store existing photo path
                    photoInput.dataset.existingPhoto = event.photo_path;
                } else {
                    photoPreviewDiv.style.display = 'none';
                    photoInput.dataset.existingPhoto = '';
                }

                // Change form to edit mode
                const form = document.getElementById('createEventForm');
                const submitBtn = document.getElementById('submitEventBtn');
                const formTitle = form.querySelector('h2');
                formTitle.textContent = '‚úèÔ∏è Edit Event';
                submitBtn.textContent = 'üíæ Update Event';
                submitBtn.dataset.eventId = eventId;
                submitBtn.dataset.mode = 'edit';

                // Show form
                form.classList.remove('hidden');
                document.getElementById('createEventBtn').style.display = 'none';

                // Scroll to form
                setTimeout(() => {
                    form.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            } catch (err) {
                console.error('‚ùå Error loading event:', err);
                alert(`‚ùå Error loading event: ${err.message}`);
            }
        }

        async function duplicateEvent(eventId) {
            try {
                // Fetch original event details
                const res = await fetch(`/events/${eventId}`);
                if (!res.ok) {
                    throw new Error('Failed to load event');
                }
                const data = await res.json();
                const event = data.event;

                // Populate form with event data
                document.getElementById('eventTitle').value = (event.title || '') + ' (Copy)';
                document.getElementById('eventOrganizer').value = event.event_organizer || '';
                document.getElementById('eventCity').value = event.city || '';
                document.getElementById('eventLocation').value = event.location || '';
                document.getElementById('eventStartDate').value = event.start_date || '';
                document.getElementById('eventStartTime').value = event.start_time || '';
                document.getElementById('eventEndDate').value = event.end_date || '';
                document.getElementById('eventEndTime').value = event.end_time || '';
                document.getElementById('eventDescription').value = event.description || '';
                document.getElementById('eventFacebookUrl').value = event.facebook_url || '';

                // Store lat/lon if available
                const latField = document.getElementById('event_location_lat');
                const lonField = document.getElementById('event_location_lon');
                if (latField) latField.value = event.lat || '';
                if (lonField) lonField.value = event.lon || '';

                // Handle photo - show existing photo and store path for reference
                const photoInput = document.getElementById('eventPhoto');
                const photoPreviewDiv = document.getElementById('eventPhotoPreview') || createPhotoPreviewDiv();

                if (event.photo_path) {
                    console.log('üì∑ Loading existing photo:', event.photo_path);
                    photoPreviewDiv.innerHTML = `
                        <div style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 5px; text-align: center;">
                            <p style="margin: 0 0 10px 0; color: #666; font-size: 12px;">üì∏ Original Photo:</p>
                            <img src="/${event.photo_path}" alt="Event Photo" style="max-width: 200px; max-height: 150px; border-radius: 3px; margin-bottom: 10px;">
                            <p style="margin: 10px 0; font-size: 12px; color: #999;">Upload a new photo or leave empty to use the same photo</p>
                        </div>
                    `;
                    photoPreviewDiv.style.display = 'block';
                    // Store existing photo path for reuse
                    photoInput.dataset.existingPhoto = event.photo_path;
                } else {
                    photoPreviewDiv.style.display = 'none';
                    photoInput.dataset.existingPhoto = '';
                }

                // Change form to create mode (not edit mode)
                const form = document.getElementById('createEventForm');
                const submitBtn = document.getElementById('submitEventBtn');
                const formTitle = form.querySelector('h2');
                formTitle.textContent = 'üìã Duplicate Event';
                submitBtn.textContent = 'üéâ Create Duplicate';
                delete submitBtn.dataset.eventId;
                delete submitBtn.dataset.mode;

                // Show form
                form.classList.remove('hidden');
                document.getElementById('createEventBtn').style.display = 'none';

                showEventMessage('üìã Form filled with duplicated event data. Modify as needed and save.', 'success');

                // Scroll to form
                setTimeout(() => {
                    form.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            } catch (err) {
                console.error('‚ùå Error duplicating event:', err);
                showEventMessage(`‚ùå Error duplicating event: ${err.message}`, 'error');
            }
        }

        function createPhotoPreviewDiv() {
            const photoFormGroup = document.getElementById('eventPhoto').parentElement;
            const previewDiv = document.createElement('div');
            previewDiv.id = 'eventPhotoPreview';
            photoFormGroup.appendChild(previewDiv);
            return previewDiv;
        }

        function showEventMessage(msg, type) {
            const msgDiv = document.getElementById('eventFormMessage');
            msgDiv.textContent = msg;
            msgDiv.style.display = 'block';
            msgDiv.style.background = type === 'error' ? '#f8d7da' : type === 'success' ? '#d4edda' : '#d1ecf1';
            msgDiv.style.color = type === 'error' ? '#721c24' : type === 'success' ? '#155724' : '#0c5460';
            msgDiv.style.border = `1px solid ${type === 'error' ? '#f5c6cb' : type === 'success' ? '#c3e6cb' : '#bee5eb'}`;
        }

        // User Management Functions (Super Admin Only)
        async function loadUsers() {
            if (!isSuperAdmin) {
                console.warn('‚ö†Ô∏è Non-super-admin trying to access user management');
                return;
            }

            try {
                console.log('üë• Loading users...');
                const res = await fetch(`/admin/users?token=${token}`);
                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.detail || 'Failed to load users');
                }

                const tbody = document.getElementById('usersList');

                if (!data.users || data.users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5">No users found</td></tr>';
                    return;
                }

                tbody.innerHTML = data.users.map(user => `
                    <tr>
                        <td data-label="User ID">${user.id}</td>
                        <td data-label="Username"><strong>${user.username}</strong></td>
                        <td data-label="Admin Status">
                            <span style="padding: 6px 12px; border-radius: 5px; ${user.is_admin ? 'background: #d4edda; color: #155724;' : 'background: #f8d7da; color: #721c24;'}">
                                ${user.is_admin ? '‚úÖ Admin' : '‚ùå Non-Admin'}
                            </span>
                        </td>
                        <td data-label="Super Admin">${user.is_super_admin ? 'üëë Yes' : '‚Äî'}</td>
                        <td data-label="Actions">
                            ${user.is_super_admin ?
                                '<span style="color: #999; font-size: 12px;">Super Admin (protected)</span>' :
                                `<button class="action-btn ${user.is_admin ? 'delete-btn' : 'edit-btn'}" onclick="toggleUserAdmin(${user.id}, ${!user.is_admin})" style="font-size: 11px; padding: 6px 12px;">
                                    ${user.is_admin ? 'üîí Remove Admin' : 'üîì Make Admin'}
                                </button>`
                            }
                        </td>
                    </tr>
                `).join('');

                console.log(`‚úÖ Loaded ${data.users.length} users`);
            } catch (err) {
                console.error('‚ùå Error loading users:', err);
                document.getElementById('usersList').innerHTML = `<tr><td colspan="5" style="color: #e74c3c;">Error: ${err.message}</td></tr>`;
            }
        }

        async function toggleUserAdmin(userId, makeAdmin) {
            if (!isSuperAdmin) {
                alert('‚ö†Ô∏è Only super admins can manage users');
                return;
            }

            const action = makeAdmin ? 'make admin' : 'remove admin status from';
            if (!confirm(`Are you sure you want to ${action} user #${userId}?`)) {
                return;
            }

            try {
                console.log(`üîÑ Toggling user #${userId} admin status to: ${makeAdmin}`);
                const formData = new FormData();
                formData.append('is_admin', makeAdmin ? '1' : '0');

                const res = await fetch(`/admin/users/${userId}/admin-status?token=${token}`, {
                    method: 'PUT',
                    body: formData
                });

                const data = await res.json();

                if (res.ok) {
                    console.log(`‚úÖ User #${userId} updated: ${data.msg}`);
                    alert(`‚úÖ ${data.msg}`);
                    loadUsers(); // Refresh the table
                } else {
                    throw new Error(data.detail || data.msg || 'Failed to update user');
                }
            } catch (err) {
                console.error('‚ùå Error updating user:', err);
                alert(`‚ùå Error: ${err.message}`);
            }
        }

    </script>
</body>
</html>

