<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dance Wizard</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(160deg, #1e3c72 0%, #2a5298 100%);
            color: #f7f7f7;
            height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 10px;
            overflow: hidden;
        }
        .app {
            width: 100%;
            max-width: 520px;
            background: rgba(0, 0, 0, 0.25);
            border-radius: 16px;
            padding: 10px;
            margin: 5px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
            max-height: 100%;
            overflow: hidden;
        }
        header h1 {
            font-size: 1.6rem;
            margin-bottom: 6px;
        }
        header p {
            font-size: 0.95rem;
            color: #d6e2ff;
            margin-bottom: 16px;
            line-height: 1.4;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
        }
        .controls button {
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 0.85rem;
            font-weight: 600;
            background: #f3f6ff;
            color: #1a2a4f;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .controls button:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25); }
        .controls button.active { background: #ffd166; color: #362300; }
        .controls button.filter-active { background: #667eea; color: white; }
        .controls-break { flex-basis: 100%; }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: linear-gradient(160deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.5);
        }
        .modal h3 {
            margin-bottom: 16px;
            font-size: 1.2rem;
            color: #fff;
        }
        .complexity-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .complexity-option {
            padding: 12px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #fff;
            font-weight: 500;
        }
        .complexity-option:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(4px);
        }
        .complexity-option.selected {
            border-color: #ffd166;
            background: rgba(255, 209, 102, 0.2);
        }
        .complexity-option.clear {
            margin-top: 8px;
            background: rgba(255, 107, 107, 0.2);
            border-color: rgba(255, 107, 107, 0.5);
        }
        .complexity-option.clear:hover {
            background: rgba(255, 107, 107, 0.3);
        }
        .stage {
            position: relative;
            width: max(200px, min(95%, 400px, calc(500px / 1.2)));
            max-width: 400px;
            max-height: 500px;
            aspect-ratio: 1 / 1.2;
            margin: 0 auto;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.35);
            border: 2px dashed rgba(255, 255, 255, 0.2);
            overflow: hidden;
            touch-action: manipulation;
        }
        .part {
            position: absolute;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.75);
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.5rem;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            cursor: pointer;
            user-select: none;
            transition: transform 0.12s ease, background 0.12s ease, box-shadow 0.12s ease;
        }
        .part:active { transform: scale(0.96); }
        .part[data-part="neck"] {
            width: 36px;
            height: 36px;
            font-size: 0.4rem;
        }
        .part[data-part="belly"] {
            width: 36px;
            height: 36px;
            font-size: 0.4rem;
        }
        .part.target { background: rgba(255, 209, 102, 0.55); box-shadow: 0 0 14px rgba(255, 209, 102, 0.8); }
        .part.correct {
            background: rgba(80, 200, 120, 0.6);
            animation: correctPulse 0.7s ease-in-out;
        }
        .part.wrong {
            background: rgba(255, 99, 132, 0.65);
            animation: wrongPulse 0.7s ease-in-out;
        }
        .stage-tooltip {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 8px;
            padding: 8px 10px;
            border-radius: 12px;
            background: rgba(255, 99, 132, 0.95);
            color: #fff;
            font-size: 0.7rem;
            font-weight: 400;
            pointer-events: none;
            opacity: 0;
            z-index: 2000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
            white-space: nowrap;
        }
        .stage-tooltip.show { opacity: 1; }
        .status {
            margin-top: 0px;
            margin-bottom: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 12px;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        .sequence {
            margin-top: 8px;
            font-size: 0.85rem;
            color: #cde1ff;
            text-align: center;
        }
        .sequence span {
            display: inline-block;
            margin: 2px 0 0 0;
            padding: 4px 8px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.12);
        }
        .sequence span.active {
            background: #ffd166;
            color: #362300;
            font-weight: 600;
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 209, 102, 0.7); }
            50% { transform: scale(1.1); box-shadow: 0 0 0 8px rgba(255, 209, 102, 0); }
        }
        @keyframes correctPulse {
            0% { box-shadow: 0 0 0 0 rgba(80, 200, 120, 0.7); }
            50% { box-shadow: 0 0 0 20px rgba(80, 200, 120, 0); }
            100% { box-shadow: 0 0 0 0 rgba(80, 200, 120, 0); }
        }
        @keyframes wrongPulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 99, 132, 0.75); }
            50% { box-shadow: 0 0 0 20px rgba(255, 99, 132, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 99, 132, 0); }
        }
        .debug {
            margin-top: 8px;
            font-size: 0.8rem;
            color: #bcd4ff;
            opacity: 0.9;
        }
        .complexity {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            vertical-align: middle;
        }
        .complexity-1 { background: rgba(80, 200, 120, 0.3); color: #50c878; }
        .complexity-2 { background: rgba(255, 209, 102, 0.3); color: #ffd166; }
        .complexity-3 { background: rgba(255, 165, 0, 0.3); color: #ffa500; }
        .complexity-4 { background: rgba(255, 107, 107, 0.3); color: #ff6b6b; }
        .complexity-5 { background: rgba(200, 50, 50, 0.3); color: #c83232; }
        @media (min-width: 900px) {
            body { padding: 40px; }
            .app { max-width: 680px; }
            .stage { aspect-ratio: 1 / 1.1; max-height: 500px; }
            .part { width: 60px; height: 60px; font-size: 0.68rem; }
            .part[data-part="neck"] {
                width: 44px;
                height: 44px;
                font-size: 0.5rem;
            }
            .part[data-part="belly"] {
                width: 44px;
                height: 44px;
                font-size: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <h1>Welcome to Dance Wizard</h1>
        </header>

        <div class="controls">
            <button id="style-salsa" class="active" type="button">Salsa</button>
            <button id="style-bachata" type="button">Bachata</button>
            <button id="complexity-filter" type="button">Complexity</button>
            <span class="controls-break"></span>
            <button id="previous-mission" type="button">Previous Mission</button>
            <button id="try-again" type="button">Try Again</button>
            <button id="next-mission" type="button">Next Mission</button>
        </div>

        <div class="modal-overlay" id="complexity-modal">
            <div class="modal">
                <h3>Select Complexity Level</h3>
                <div class="complexity-options">
                    <div class="complexity-option" data-complexity="1">
                        <span class="complexity complexity-1">Easy (1/5)</span> - Simple, short sequences
                    </div>
                    <div class="complexity-option" data-complexity="2">
                        <span class="complexity complexity-2">Easy-Medium (2/5)</span> - Basic patterns
                    </div>
                    <div class="complexity-option" data-complexity="3">
                        <span class="complexity complexity-3">Medium (3/5)</span> - Moderate complexity
                    </div>
                    <div class="complexity-option" data-complexity="4">
                        <span class="complexity complexity-4">Medium-Hard (4/5)</span> - Longer, complex sequences
                    </div>
                    <div class="complexity-option" data-complexity="5">
                        <span class="complexity complexity-5">Hard (5/5)</span> - Most challenging
                    </div>
                    <div class="complexity-option clear" data-complexity="0">
                        Clear Filter (Random from all)
                    </div>
                </div>
            </div>
        </div>

        <div class="status" id="status">
            <div id="status-message">Tap "Next Mission" to begin a sequence.</div>
            <div class="sequence" id="sequence"></div>
            <div class="stage-tooltip" id="stage-tooltip"></div>
            <div class="debug" id="debug"></div>
        </div>

        <div class="stage" id="stage">
            <div class="part" data-part="head" style="top: 3%; left: 50%; transform: translate(-50%, 0);">Head</div>
            <div class="part" data-part="left-shoulder" style="top: 23%; left: 20%;">L Shoulder</div>
            <div class="part" data-part="neck" style="top: 18%; left: 50%; transform: translate(-50%, 0);">Neck</div>
            <div class="part" data-part="right-shoulder" style="top: 23%; right: 20%;">R Shoulder</div>
            <div class="part" data-part="left-hand" style="top: 36%; left: 8%;">L Hand</div>
            <div class="part" data-part="right-hand" style="top: 36%; right: 8%;">R Hand</div>
            <div class="part" data-part="chest" style="top: 29%; left: 50%; transform: translate(-50%, 0);">Chest</div>
            <div class="part" data-part="belly" style="top: 44%; left: 50%; transform: translate(-50%, 0);">Belly</div>
            <div class="part" data-part="left-hip" style="top: 54%; left: 30%;">L Hip</div>
            <div class="part" data-part="right-hip" style="top: 54%; right: 30%;">R Hip</div>
            <div class="part" data-part="left-upper-leg" style="top: 69%; left: 28%;">L Upper Leg</div>
            <div class="part" data-part="right-upper-leg" style="top: 69%; right: 28%;">R Upper Leg</div>
            <div class="part" data-part="left-lower-leg" style="top: 84%; left: 28%;">L Lower Leg</div>
            <div class="part" data-part="right-lower-leg" style="top: 84%; right: 28%;">R Lower Leg</div>
        </div>
    </div>

    <script>
        const missions = {
            salsa: [
                { name: "Basic Shine", complexity: 2, sequence: ["head", "chest", "left-hip", "right-hip", "left-upper-leg", "right-upper-leg"] },
                { name: "SuziQ Shine", complexity: 3, sequence: ["left-shoulder", "neck", "right-shoulder", "chest", "left-upper-leg", "right-upper-leg"] },
                { name: "Cross Body Flow", complexity: 4, sequence: ["head", "left-shoulder", "right-shoulder", "left-hip", "right-hip", "left-lower-leg", "right-lower-leg"] },
                { name: "Shoulder Roll", complexity: 2, sequence: ["left-shoulder", "neck", "right-shoulder", "chest", "left-shoulder", "right-shoulder"] },
                { name: "Hip Isolation", complexity: 2, sequence: ["left-hip", "right-hip", "left-hip", "right-hip", "chest", "head"] },
                { name: "Hand Flow", complexity: 3, sequence: ["left-hand", "right-hand", "left-shoulder", "right-shoulder", "chest", "head"] },
                { name: "Full Body Wave", complexity: 4, sequence: ["head", "neck", "chest", "belly", "left-hip", "right-hip", "left-upper-leg", "right-upper-leg"] },
                { name: "Leg Work", complexity: 3, sequence: ["left-upper-leg", "right-upper-leg", "left-lower-leg", "right-lower-leg", "left-hip", "right-hip"] },
                { name: "Chest Pop", complexity: 2, sequence: ["chest", "head", "chest", "left-shoulder", "right-shoulder", "chest"] },
                { name: "Spiral Turn", complexity: 4, sequence: ["head", "left-shoulder", "chest", "right-shoulder", "left-hip", "right-hip", "head"] }
            ],
            bachata: [
                { name: "Body Wave", complexity: 2, sequence: ["head", "neck", "chest", "belly", "left-hip", "right-hip"] },
                { name: "Hip Tap", complexity: 2, sequence: ["left-hip", "right-hip", "left-upper-leg", "right-upper-leg", "left-hip"] },
                { name: "Soft Step", complexity: 1, sequence: ["left-lower-leg", "right-lower-leg", "left-lower-leg", "right-lower-leg"] },
                { name: "Hip Circle", complexity: 2, sequence: ["left-hip", "belly", "right-hip", "belly", "left-hip", "right-hip"] },
                { name: "Sensual Wave", complexity: 4, sequence: ["head", "neck", "chest", "belly", "left-hip", "right-hip", "left-upper-leg", "right-upper-leg"] },
                { name: "Shoulder Shake", complexity: 2, sequence: ["left-shoulder", "right-shoulder", "left-shoulder", "right-shoulder", "neck", "head"] },
                { name: "Hip Sway", complexity: 2, sequence: ["left-hip", "right-hip", "left-hip", "right-hip", "belly", "chest"] },
                { name: "Footwork Pattern", complexity: 3, sequence: ["left-lower-leg", "right-lower-leg", "left-upper-leg", "right-upper-leg", "left-hip", "right-hip"] },
                { name: "Body Roll", complexity: 3, sequence: ["head", "neck", "chest", "belly", "left-hip", "right-hip", "belly", "chest"] },
                { name: "Hand to Hip", complexity: 3, sequence: ["left-hand", "left-hip", "right-hand", "right-hip", "left-hip", "right-hip"] }
            ]
        };

        let activeStyle = "salsa";
        let activeMission = null;
        let progressIndex = 0;
        let selectedComplexity = null; // null = no filter, 0-5 = specific complexity
        let missionHistory = []; // Array to store mission history
        let currentHistoryIndex = -1; // Current position in history (-1 means no history)
        let missionStartTime = null; // Track when mission started
        let sequenceRecords = {}; // Cache for sequence records

        const statusEl = document.getElementById("status");
        const statusMessageEl = document.getElementById("status-message");
        const sequenceEl = document.getElementById("sequence");
        const debugEl = document.getElementById("debug");
        const parts = Array.from(document.querySelectorAll(".part"));
        const complexityModal = document.getElementById("complexity-modal");
        const complexityFilterBtn = document.getElementById("complexity-filter");

        function setStyle(style) {
            activeStyle = style;
            document.getElementById("style-salsa").classList.toggle("active", style === "salsa");
            document.getElementById("style-bachata").classList.toggle("active", style === "bachata");
            resetMission();
            statusMessageEl.textContent = "Tap \"Next Mission\" to begin a " + style + " sequence.";
        }

        function renderSequence() {
            sequenceEl.innerHTML = "";
            if (!activeMission) return;
            
            // Show only the next move that needs to be pressed
            if (progressIndex < activeMission.sequence.length) {
                const nextPart = activeMission.sequence[progressIndex];
                const pill = document.createElement("span");
                pill.textContent = nextPart.replace("-", " ");
                pill.classList.add("active");
                sequenceEl.appendChild(pill);
            }
        }

        function updateTargetHighlight() {
            parts.forEach((part) => {
                part.classList.remove("target", "correct", "wrong");
                // Target highlighting removed - user must find the next move themselves
            });
        }

        function getComplexityLabel(level) {
            const labels = ["", "Easy", "Easy-Medium", "Medium", "Medium-Hard", "Hard"];
            return labels[level] || "Unknown";
        }

        function loadMission(mission, style, savedProgress = 0) {
            activeMission = mission;
            activeStyle = style;
            progressIndex = savedProgress;
            missionStartTime = savedProgress === 0 ? performance.now() : null; // Only start timer if starting fresh
            const complexity = activeMission.complexity || 1;
            const complexityLabel = getComplexityLabel(complexity);
            const complexityBadge = `<span class="complexity complexity-${complexity}">${complexityLabel} (${complexity}/5)</span>`;
            statusMessageEl.innerHTML = "Mission: " + activeMission.name + complexityBadge;
            renderSequence();
            updateTargetHighlight();
            debugEl.textContent = "";
            // Update style buttons
            document.getElementById("style-salsa").classList.toggle("active", style === "salsa");
            document.getElementById("style-bachata").classList.toggle("active", style === "bachata");
            // Load and display record for this sequence
            loadSequenceRecord(mission.name, style);
        }

        function startMission() {
            let pool = missions[activeStyle];
            
            // Filter by complexity if one is selected
            if (selectedComplexity !== null && selectedComplexity !== 0) {
                pool = pool.filter(mission => mission.complexity === selectedComplexity);
                if (pool.length === 0) {
                    statusMessageEl.textContent = `No missions found for complexity ${selectedComplexity}. Try a different filter.`;
                    return;
                }
            }
            
            const newMission = pool[Math.floor(Math.random() * pool.length)];
            
            // If we're not at the end of history, remove everything after current index
            if (currentHistoryIndex < missionHistory.length - 1) {
                missionHistory = missionHistory.slice(0, currentHistoryIndex + 1);
            }
            
            // Add new mission to history
            missionHistory.push({
                mission: newMission,
                style: activeStyle,
                progressIndex: 0
            });
            currentHistoryIndex = missionHistory.length - 1;
            
            loadMission(newMission, activeStyle, 0);
        }

        function resetMission() {
            activeMission = null;
            progressIndex = 0;
            sequenceEl.innerHTML = "";
            updateTargetHighlight();
            debugEl.textContent = "";
            missionHistory = [];
            currentHistoryIndex = -1;
        }

        function previousMission() {
            if (currentHistoryIndex > 0) {
                currentHistoryIndex--;
                const historyItem = missionHistory[currentHistoryIndex];
                loadMission(historyItem.mission, historyItem.style, historyItem.progressIndex);
            } else {
                statusMessageEl.textContent = "No previous mission. Tap Next Mission to begin.";
            }
        }

        function nextMission() {
            if (currentHistoryIndex < missionHistory.length - 1) {
                // Go forward in history
                currentHistoryIndex++;
                const historyItem = missionHistory[currentHistoryIndex];
                loadMission(historyItem.mission, historyItem.style, historyItem.progressIndex);
            } else {
                // Start a new mission
                startMission();
            }
        }

        function handleTap(partName, element) {
            if (!activeMission) {
                debugEl.textContent = "No mission active. Tap Next Mission.";
                return;
            }

            const expected = activeMission.sequence[progressIndex];
            parts.forEach((part) => part.classList.remove("correct", "wrong"));

            if (partName === expected) {
                element.classList.add("correct");
                progressIndex += 1;
                
                // Update progress in history
                if (currentHistoryIndex >= 0 && currentHistoryIndex < missionHistory.length) {
                    missionHistory[currentHistoryIndex].progressIndex = progressIndex;
                }
                
                if (progressIndex >= activeMission.sequence.length) {
                    // Mission completed - calculate time
                    const completionTime = missionStartTime ? (performance.now() - missionStartTime) / 1000 : null; // Convert to seconds
                    const complexity = activeMission.complexity || 1;
                    const complexityLabel = getComplexityLabel(complexity);
                    const complexityBadge = `<span class="complexity complexity-${complexity}">${complexityLabel} (${complexity}/5)</span>`;
                    
                    let completionMsg = "Nice! Mission complete: " + activeMission.name + complexityBadge;
                    if (completionTime !== null) {
                        const timeStr = formatTime(completionTime);
                        completionMsg += `<br>Time: ${timeStr}`;
                        // Save record to backend
                        saveSequenceRecord(activeMission.name, activeStyle, completionTime);
                    }
                    statusMessageEl.innerHTML = completionMsg;
                    activeMission = null;
                    sequenceEl.innerHTML = "";
                    missionStartTime = null;
                } else {
                    statusMessageEl.textContent = "Good! Next target...";
                }
            } else {
                element.classList.add("wrong");
                statusMessageEl.textContent = "Wrong spot. Restart this mission.";
                progressIndex = 0;
                missionStartTime = performance.now(); // Restart timer
                // Update progress in history
                if (currentHistoryIndex >= 0 && currentHistoryIndex < missionHistory.length) {
                    missionHistory[currentHistoryIndex].progressIndex = 0;
                }
                showStageTooltip("Start from the beginning.", element);
            }

            renderSequence();
            // Don't call updateTargetHighlight() here as it removes correct/wrong classes
            // updateTargetHighlight();
            debugEl.textContent = "Last tap: " + partName.replace("-", " ");
            
            // Remove correct/wrong classes after animation completes
            setTimeout(() => {
                element.classList.remove("correct", "wrong");
            }, 700);
        }

        let tooltipTimeoutId = null;
        function showStageTooltip(message, targetEl) {
            const tooltip = document.getElementById("stage-tooltip");
            const sequenceEl = document.getElementById("sequence");
            if (!tooltip || !sequenceEl) return;

            // Position tooltip relative to the sequence element (where active move is shown)
            const sequenceRect = sequenceEl.getBoundingClientRect();
            const statusRect = statusEl.getBoundingClientRect();
            
            // Position tooltip below the sequence element
            tooltip.style.position = 'absolute';
            tooltip.style.top = `${sequenceRect.bottom - statusRect.top + 8}px`;
            tooltip.style.left = '50%';
            tooltip.style.transform = 'translateX(-50%)';

            tooltip.textContent = message;
            tooltip.classList.add("show");

            if (tooltipTimeoutId) {
                clearTimeout(tooltipTimeoutId);
            }
            tooltipTimeoutId = setTimeout(() => {
                tooltip.classList.remove("show");
            }, 3000);
        }

        parts.forEach((part) => {
            part.addEventListener("pointerdown", (event) => {
                event.preventDefault();
                handleTap(part.dataset.part, part);
            });
        });

        function updateComplexityFilterButton() {
            if (selectedComplexity === null || selectedComplexity === 0) {
                complexityFilterBtn.textContent = "Complexity";
                complexityFilterBtn.classList.remove("filter-active");
            } else {
                const label = getComplexityLabel(selectedComplexity);
                complexityFilterBtn.textContent = `Filter: ${label}`;
                complexityFilterBtn.classList.add("filter-active");
            }
        }

        function selectComplexity(complexity) {
            if (complexity === 0) {
                selectedComplexity = null;
            } else {
                selectedComplexity = complexity;
            }
            updateComplexityFilterButton();
            complexityModal.classList.remove("show");
            
            // Update selected state in modal
            document.querySelectorAll(".complexity-option").forEach(option => {
                option.classList.remove("selected");
            });
            if (selectedComplexity !== null) {
                const selectedOption = document.querySelector(`[data-complexity="${selectedComplexity}"]`);
                if (selectedOption) selectedOption.classList.add("selected");
            }
        }

        // Open complexity filter modal
        complexityFilterBtn.addEventListener("click", () => {
            // Update selected state in modal
            document.querySelectorAll(".complexity-option").forEach(option => {
                option.classList.remove("selected");
            });
            if (selectedComplexity !== null && selectedComplexity !== 0) {
                const selectedOption = document.querySelector(`[data-complexity="${selectedComplexity}"]`);
                if (selectedOption) selectedOption.classList.add("selected");
            }
            complexityModal.classList.add("show");
        });

        // Close modal when clicking overlay
        complexityModal.addEventListener("click", (e) => {
            if (e.target === complexityModal) {
                complexityModal.classList.remove("show");
            }
        });

        // Handle complexity option clicks
        document.querySelectorAll(".complexity-option").forEach(option => {
            option.addEventListener("click", () => {
                const complexity = parseInt(option.dataset.complexity);
                selectComplexity(complexity);
            });
        });

        function formatTime(seconds) {
            const wholeSeconds = Math.floor(seconds);
            const milliseconds = Math.floor((seconds - wholeSeconds) * 1000);
            return `${wholeSeconds}.${milliseconds.toString().padStart(3, '0')}s`;
        }

        async function saveSequenceRecord(sequenceName, style, completionTime) {
            try {
                // Optimistic UI update for faster feedback
                displaySequenceRecord(sequenceName, style, { completion_time: completionTime });
                const response = await fetch('/api/dance-sequences/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sequence_name: sequenceName,
                        style: style,
                        completion_time: completionTime
                    })
                });
                
                if (response.ok) {
                    const record = await response.json();
                    sequenceRecords[`${sequenceName}_${style}`] = record;
                    // Reload the record display
                    loadSequenceRecord(sequenceName, style);
                }
            } catch (error) {
                console.error('Failed to save sequence record:', error);
            }
        }

        async function loadSequenceRecord(sequenceName, style) {
            const cacheKey = `${sequenceName}_${style}`;
            if (sequenceRecords[cacheKey]) {
                // Fast render from cache while fetching fresh data
                displaySequenceRecord(sequenceName, style, sequenceRecords[cacheKey]);
            } else {
                displaySequenceRecord(sequenceName, style, null, true);
            }
            try {
                const response = await fetch(`/api/dance-sequences/record/${encodeURIComponent(sequenceName)}/${style}`);
                if (response.ok) {
                    const record = await response.json();
                    sequenceRecords[cacheKey] = record;
                    displaySequenceRecord(sequenceName, style, record);
                } else if (response.status === 404) {
                    // No record yet
                    displaySequenceRecord(sequenceName, style, null);
                }
            } catch (error) {
                console.error('Failed to load sequence record:', error);
            }
        }

        function displaySequenceRecord(sequenceName, style, record, isLoading = false) {
            // Find or create record display element
            let recordEl = document.getElementById('sequence-record');
            if (!recordEl) {
                recordEl = document.createElement('div');
                recordEl.id = 'sequence-record';
                recordEl.style.cssText = 'margin-top: 8px; font-size: 0.85rem; color: #ffd166; text-align: center; font-weight: 600;';
                const sequenceDiv = document.getElementById('sequence');
                if (sequenceDiv && sequenceDiv.parentNode) {
                    sequenceDiv.parentNode.insertBefore(recordEl, sequenceDiv);
                } else if (statusEl) {
                    statusEl.appendChild(recordEl);
                }
            }
            
            if (isLoading) {
                recordEl.textContent = 'ðŸ† Checking record...';
            } else if (record) {
                recordEl.textContent = `ðŸ† Best time: ${formatTime(record.completion_time)}`;
            } else {
                recordEl.textContent = 'ðŸ† No record yet - be the first!';
            }
        }

        function tryAgain() {
            // If mission finished, activeMission is null but history still has it.
            if (!activeMission) {
                if (currentHistoryIndex >= 0 && currentHistoryIndex < missionHistory.length) {
                    const historyItem = missionHistory[currentHistoryIndex];
                    historyItem.progressIndex = 0;
                    loadMission(historyItem.mission, historyItem.style, 0);
                    return;
                }
                statusMessageEl.textContent = "No active mission. Tap Next Mission to begin.";
                return;
            }

            // Restart current mission
            progressIndex = 0;
            missionStartTime = performance.now();

            // Update history if applicable
            if (currentHistoryIndex >= 0 && currentHistoryIndex < missionHistory.length) {
                missionHistory[currentHistoryIndex].progressIndex = 0;
            }

            // Clear all visual feedback
            parts.forEach((part) => {
                part.classList.remove("correct", "wrong", "target");
            });

            // Update status message with mission info
            const complexity = activeMission.complexity || 1;
            const complexityLabel = getComplexityLabel(complexity);
            const complexityBadge = `<span class="complexity complexity-${complexity}">${complexityLabel} (${complexity}/5)</span>`;
            statusMessageEl.innerHTML = "Mission: " + activeMission.name + complexityBadge;

            // Render the first move
            renderSequence();
            updateTargetHighlight();
            debugEl.textContent = "";
        }

        // Initialize button state
        updateComplexityFilterButton();

        document.getElementById("style-salsa").addEventListener("click", () => setStyle("salsa"));
        document.getElementById("style-bachata").addEventListener("click", () => setStyle("bachata"));
        document.getElementById("next-mission").addEventListener("click", nextMission);
        document.getElementById("previous-mission").addEventListener("click", previousMission);
        document.getElementById("try-again").addEventListener("click", tryAgain);
    </script>
</body>
</html>
